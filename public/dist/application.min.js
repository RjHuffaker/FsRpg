"use strict";var ApplicationConfiguration=function(){var applicationModuleName="fsrpg",applicationModuleVendorDependencies=["ngResource","ngCookies","ngAnimate","ngTouch","ngSanitize","ui.router","ui.bootstrap","ui.utils","btford.socket-io"],registerModule=function(moduleName,dependencies){angular.module(moduleName,dependencies||[]),angular.module(applicationModuleName).requires.push(moduleName)};return{applicationModuleName:applicationModuleName,applicationModuleVendorDependencies:applicationModuleVendorDependencies,registerModule:registerModule}}();angular.module(ApplicationConfiguration.applicationModuleName,ApplicationConfiguration.applicationModuleVendorDependencies),angular.module(ApplicationConfiguration.applicationModuleName).config(["$locationProvider",function($locationProvider){$locationProvider.hashPrefix("!")}]),angular.element(document).ready(function(){"#_=_"===window.location.hash&&(window.location.hash="#!"),angular.bootstrap(document,[ApplicationConfiguration.applicationModuleName])}),ApplicationConfiguration.registerModule("builder"),ApplicationConfiguration.registerModule("campaigns"),ApplicationConfiguration.registerModule("cards"),ApplicationConfiguration.registerModule("core"),ApplicationConfiguration.registerModule("decks"),ApplicationConfiguration.registerModule("move"),ApplicationConfiguration.registerModule("narrator"),ApplicationConfiguration.registerModule("npcs"),ApplicationConfiguration.registerModule("pcs"),ApplicationConfiguration.registerModule("player"),ApplicationConfiguration.registerModule("users"),angular.module("core").factory("BuilderHub",["$rootScope","Bakery","DecksBread",function($rootScope,Bakery,DecksBread){var service={};return service.toggleCardLock=function(panel,cardList){for(var i=0;i<cardList.length;i++)panel===cardList[i]&&(cardList[i].locked=!cardList[i].locked)},service.findDependency=function(deck,resource){for(var index=-1,i=0;i<resource.dependencies.length;i++){var dependency=resource.dependencies[i];dependency._id===deck._id&&(index=i)}return index},service.toggleDependency=function(deck,resource){var deckIndex=service.findDependency(deck,resource);deckIndex>-1?resource.dependencies.splice(deckIndex,1):resource.dependencies.push(deck);for(var i=0;i<resource.dependencies.length;i++)DecksBread.browseAspects(resource.dependencies[i])},service.changeAspect=function(card,aspect){console.log(card),console.log(aspect),card.aspect!==aspect&&(card.aspect=aspect)},service}]),angular.module("campaigns").controller("CampaignsController",["$scope","Socket",function($scope,Socket){$scope.messages=[],$scope.users=[];var init=function(){$scope.name=window.user.username,$scope.messages.push({user:"",text:$scope.name+" has joined."}),Socket.emit("user:init",{name:window.user.username})};Socket.on("user:init",function(data){console.log(data);for(var message in data.messages)$scope.messages.push(message);for(var user in data.users)$scope.users.push(user)}),Socket.on("send:message",function(message){$scope.messages.push(message)}),Socket.on("user:join",function(data){$scope.messages.push({user:"",text:data.name+" has joined."}),$scope.users.push(data.name)}),Socket.on("user:left",function(data){$scope.messages.push({user:"chatroom",text:data.name+" has left."})}),$scope.messages=[],$scope.sendMessage=function(){$scope.message&&(Socket.emit("send:message",{user:$scope.name,text:$scope.message}),$scope.messages.push({user:$scope.name,text:$scope.message}),$scope.message="")},init()}]),angular.module("campaigns").factory("Campaigns",["$stateParams","$location","Authentication","$resource",function($stateParams,$location,Authentication,$resource){var Campaigns=$resource("campaigns/:campaignId",{campaignId:"@_id"},{update:{method:"PUT"}}),service={};return service.campaign={},service.campaignList=[],service.browseCampaigns=function(){this.campaignList=Campaigns.query(function(response){})},service.readCampaign=function(){this.campaign=Campaigns.get({campaignId:$stateParams.campaignId})},service.editCampaign=function(){var campaign=this.campaign;campaign.$update(function(){},function(errorResponse){this.error=errorResponse.data.message})},service.addCampaign=function(){this.campaign=new Campaigns({}),this.campaign.$save(function(response){$location.path("campaign/campaigns/"+response._id+"/edit")},function(errorResponse){this.error=errorResponse.data.message})},service.deleteCampaign=function(campaign){if(campaign){campaign.$remove();for(var i in this.campaigns)this.campaigns[i]===campaign&&this.campaigns.splice(i,1)}else this.campaign.$remove(function(){$location.path("campaign/campaigns")});this.browseCampaigns()},service}]),angular.module("cards").directive("cardForm",["$rootScope",function($rootScope){return{restrict:"A",require:"^form",link:function(scope,element,attr){scope.$on("Bakery: deckSaved",function(){scope.featureCardForm.$setPristine()})}}}]).directive("cardLogo",["$rootScope",function($rootScope){return{restrict:"A",templateUrl:"../modules/cards/views/card-logo.html"}}]).directive("cardHeader",function(){return{restrict:"A",templateUrl:"../modules/cards/views/card-header.html"}}).directive("cardDescription",function(){return{restrict:"A",templateUrl:"../modules/cards/views/card-description.html"}}).directive("cardModifiers",function(){return{restrict:"A",templateUrl:"../modules/cards/views/card-modifiers.html"}}).directive("cardBenefit",function(){return{restrict:"A",templateUrl:"../modules/cards/views/card-benefit.html"}}).directive("cardFooter",function(){return{restrict:"A",templateUrl:"../modules/cards/views/card-footer.html"}}).directive("cardAction",["DataSRVC",function(DataSRVC){return{restrict:"A",templateUrl:"../modules/cards/views/card-action.html",scope:{cardAction:"=",panel:"="},link:function(scope,element,attrs){scope.dataSRVC=DataSRVC}}}]).directive("cardActionIcon",function(){return{restrict:"A",templateUrl:"../modules/cards/views/card-action-icon.html"}}).directive("cardActionTitle",function(){return{restrict:"A",templateUrl:"../modules/cards/views/card-action-title.html"}}).directive("cardActionKeywords",function(){return{restrict:"A",templateUrl:"../modules/cards/views/card-action-keywords.html"}}).directive("cardActionPrompt",function(){return{restrict:"A",templateUrl:"../modules/cards/views/card-action-prompt.html"}}).directive("cardActionEffect",function(){return{restrict:"A",templateUrl:"../modules/cards/views/card-action-effect.html"}}).directive("cardActionAttack",function(){return{restrict:"A",templateUrl:"../modules/cards/views/card-action-attack.html"}}).directive("cardActionDefense",function(){return{restrict:"A",templateUrl:"../modules/cards/views/card-action-defense.html"}}).directive("originStats",function(){return{restrict:"A",templateUrl:"../modules/cards/views/origin-stats.html"}}).directive("originDefenses",function(){return{restrict:"A",templateUrl:"../modules/cards/views/origin-defenses.html"}}).directive("diceDropdown",function(){return{restrict:"A",templateUrl:"../modules/pcs/views/dice-dropdown.html",scope:{ability:"="}}}).directive("stopEvent",function(){return{restrict:"A",link:function(scope,element,attrs){var _pressEvents="touchstart mousedown";element.on(_pressEvents,function(event){scope.panel.left.overlap||scope.panel.above.overlap||event.stopPropagation()})}}}).directive("stopClick",function(){return{restrict:"A",link:function(scope,element,attrs){element.on("click",function(event){event.stopPropagation()})}}}).directive("elasticTextarea",["$timeout",function($timeout){return{restrict:"A",link:function(scope,element,attrs){var resizeArea=function(){setTimeout(function(){element[0].style.height=element[0].scrollHeight+"px"},25)};scope.$watch(function(){return element[0].scrollHeight},function(newValue,oldValue){newValue!==oldValue&&resizeArea()}),resizeArea()}}}]).directive("fitContent",function(){return{restrict:"A",scope:!1,link:function(scope,element,attrs){var reduceText=function(){setTimeout(function(){for(var fontSize=parseInt(element.css("font-size"));element[0].offsetHeight>element.parent()[0].offsetHeight&&fontSize>=6;)fontSize--,element.css("font-size",fontSize+"px")},25)};scope.$watch(function(){return element[0].offsetHeight},function(newValue,oldValue){newValue>oldValue&&reduceText()}),reduceText()}}}),angular.module("cards").directive("playerOptions",function(){return{restrict:"A",templateUrl:"../modules/player/views/options-player.html"}}).directive("pcSummary",function(){return{restrict:"A",templateUrl:"../modules/pcs/views/pc-summary.html"}}).directive("pcOptions",function(){return{restrict:"A",templateUrl:"../modules/pcs/views/pc-options.html"}}).directive("cardPc1",function(){return{restrict:"A",templateUrl:"../modules/pcs/views/card-pc-1.html"}}).directive("cardPc2",function(){return{restrict:"A",templateUrl:"../modules/pcs/views/card-pc-2.html"}}).directive("cardPc3",function(){return{restrict:"A",templateUrl:"../modules/pcs/views/card-pc-3.html"}}).directive("featureCard",["DataSRVC","Bakery","BuilderHub",function(DataSRVC,Bakery,BuilderHub){return{restrict:"A",templateUrl:"../modules/cards/views/feature-card.html",scope:{card:"=",panel:"="},link:function(scope,element,attrs){scope.Bakery=Bakery,scope.dataSRVC=DataSRVC,scope.BuilderHub=BuilderHub}}}]).directive("narratorOptions",function(){return{restrict:"A",templateUrl:"../modules/narrator/views/options-narrator.html"}}).directive("npcSummary",function(){return{restrict:"A",templateUrl:"../modules/npcs/views/npc-summary.html"}}).directive("npcOptions",function(){return{restrict:"A",templateUrl:"../modules/npcs/views/npc-options.html"}}).directive("npcOrigin",function(){return{restrict:"A",templateUrl:"../modules/npcs/views/npc-origin.html"}}).directive("builderOptions",function(){return{restrict:"A",templateUrl:"../modules/builder/views/options-builder.html"}}).directive("deckSummary",function(){return{restrict:"A",templateUrl:"../modules/decks/views/deck-summary.html"}}).directive("deckOptions",function(){return{restrict:"A",templateUrl:"../modules/decks/views/deck-options.html"}}).directive("campaignSummary",function(){return{restrict:"A",templateUrl:"../modules/campaigns/views/campaign-summary.html"}}).directive("campaignOptions",function(){return{restrict:"A",templateUrl:"../modules/campaigns/views/campaign-options.html"}}).directive("deckDemo",function(){return{restrict:"A",templateUrl:"../modules/core/views/deck-demo.html"}}),angular.module("cards").factory("Aspects",["$resource",function($resource){return $resource("aspect/:aspectId",{aspectId:"@_id"},{update:{method:"PUT"},list:{url:"/aspects",method:"GET",isArray:!0},query:{url:"/aspects/:deckId",method:"GET",isArray:!0,params:{deckId:"@_id"}}})}]),angular.module("cards").factory("Augments",["$resource",function($resource){return $resource("augments/:augmentId",{augmentId:"@_id"},{update:{method:"PUT"}})}]),angular.module("cards").factory("CardsBread",["Bakery","PanelUtils","DeckUtils",function(Bakery,PanelUtils,DeckUtils){var service={},editDeck=function(deck,_loadDeck){var _deck=new Bakery.Decks(deck);_deck.$update(function(response){_loadDeck&&(Bakery.resource=response)},function(errorResponse){console.log(errorResponse)})};return service.browse=function(cardType,params,destination){var cardParams=PanelUtils.getCardParams(params);Bakery.getCardResource(cardType).query(cardParams,function(response){return response})},service.read=function(panel,callback){var params=PanelUtils.getCardParams(panel);Bakery.getCardResource(panel.panelType).get(params,function(response){callback(panel,response)})},service.edit=function(panel){var cardResource=Bakery.getNewCardResource(panel);if("Aspect"!==panel.panelType){var panelData=PanelUtils.getPanelData(panel);panelData.aspect&&(cardResource.aspect=panelData.aspect._id)}cardResource.$update()},service.add=function(resource,prevId,cardNumber,callback){var _prev;_prev=prevId?PanelUtils.getPanel(resource.cardList,prevId):PanelUtils.getLast(resource.cardList).panel,console.log("add: _prev._id = "+_prev._id);var card=(PanelUtils.getNext(resource.cardList,_prev._id).panel,{deck:resource._id,deckName:resource.name,deckSize:resource.deckSize,cardNumber:cardNumber,cardType:resource.deckType}),panel={panelType:resource.deckType,x_coord:_prev.x_coord+15,y_coord:0};PanelUtils.setPanelData(panel,card);var cardResource=Bakery.getNewCardResource(panel);cardResource.$save(function(response){PanelUtils.setPanelData(panel,response),resource.cardList.push(panel)}).then(function(response){callback&&callback(response)})},service["delete"]=function(resource,panel){if("architectOptions"!==panel.panelType){var cardResource=Bakery.getNewCardResource(panel);cardResource.$remove(function(response){resource&&PanelUtils.removePanel(resource.cardList,panel)}).then(function(response){resource&&DeckUtils.setDeckSize(resource)}).then(function(response){resource&&DeckUtils.collapseDeck(resource.cardList,panel)}).then(function(response){resource&&editDeck(resource,!1)})}},service}]),angular.module("cards").factory("Feats",["$resource",function($resource){return $resource("feats/:featId",{featId:"@_id"},{update:{method:"PUT"}})}]),angular.module("cards").factory("Items",["$resource",function($resource){return $resource("items/:itemId",{itemId:"@_id"},{update:{method:"PUT"}})}]),angular.module("cards").factory("Notes",["$resource",function($resource){return $resource("notes/:noteId",{noteId:"@_id"},{update:{method:"PUT"}})}]),angular.module("cards").factory("Origins",["$resource",function($resource){return $resource("origins/:originId",{originId:"@_id"},{update:{method:"PUT"}})}]),angular.module("cards").factory("Traits",["$resource",function($resource){return $resource("traits/:traitId",{traitId:"@_id"},{update:{method:"PUT"}})}]),angular.module("core").config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$urlRouterProvider.otherwise("/"),$stateProvider.state("home",{url:"/",templateUrl:"modules/core/views/home.client.view.html"})}]),angular.module("core").controller("CoreController",["$scope","$rootScope","Authentication","Bakery","CardsBread","DecksBread","PcsBread","DataSRVC","PcsTraits","PcsFeats","PcsAugments","PcsItems","BuilderHub","PlayerHub","CoreVars","DeckUtils","shuffleDeck",function($scope,$rootScope,Authentication,Bakery,CardsBread,DecksBread,PcsBread,DataSRVC,PcsTraits,PcsFeats,PcsAugments,PcsItems,BuilderHub,PlayerHub,CoreVars,DeckUtils,shuffleDeck){$scope.authentication=Authentication,$scope.Bakery=Bakery,$scope.dataSRVC=DataSRVC,$scope.pcsTraits=PcsTraits,$scope.pcsFeats=PcsFeats,$scope.pcsAugments=PcsAugments,$scope.pcsItems=PcsItems,$scope.BuilderHub=BuilderHub,$scope.PlayerHub=PlayerHub,$scope.CoreVars=CoreVars;var pcNew=!1,initialize=function(){toggleListeners(!0)},toggleListeners=function(enable){enable&&($scope.$on("$destroy",onDestroy),$scope.$on("ability:onPress",PlayerHub.chooseAbility),$scope.$watch("CoreVars.EXP",PlayerHub.watchEXP),$scope.$watch("Bakery.resource.experience",PlayerHub.watchExperience),$scope.$watch("Bakery.resource.level",PlayerHub.watchLevel))},onDestroy=function(){toggleListeners(!1)};$scope.browsePcs=function(){PcsBread.browse()},$scope.browseDecks=function(param){DecksBread.browse(param)},$scope.readCard=function(card){CardsBread.read(card,CardsBread.setPanelData)},$scope.readDeck=function(deck){DecksBread.read(deck)},$scope.readPc=function(pc){PcsBread.read(pc),pcNew=!1},$scope.addCard=function(deck,cardType,cardNumber,deckShift,deckSave){CardsBread.add(deck,cardType,cardNumber,deckShift,deckSave)},$scope.addDeck=function(type,size){DecksBread.add(type,size)},$scope.addPc=function(){PcsBread.add(),pcNew=!0},$scope.editCard=function(card){CardsBread.edit(card)},$scope.editDeck=function(deck){DecksBread.edit(deck)},$scope.editPc=function(pc){PcsBread.edit(pc),pcNew=!1},$scope.deleteCard=function(panel){CardsBread["delete"](Bakery.resource,panel)},$scope.deleteDeck=function(deck){DecksBread["delete"](Bakery.resource,deck)},$scope.deletePc=function(pc){PcsBread["delete"](Bakery.resource,pc)},$scope.exitPc=function(pc){pcNew&&PcsBread["delete"](Bakery.resource,pc),$scope.browsePcs()},$scope.shuffleDeck=function(cardList){shuffleDeck(cardList)},$scope.changeFeatureCard=function(card){$scope.modalShown=!0,$scope.modalDeckShown=!0,PcsTraits.browseCards()},$scope.status={isopen:!1},$scope.toggled=function(open){$scope.status.isopen=open,$rootScope.$broadcast("CardsCtrl:onDropdown",{isOpen:$scope.status.isopen})},initialize()}]),angular.module("core").controller("HeaderController",["$document","$rootScope","$scope","Authentication","Menus","CardsBread","DecksBread","PcsBread",function($document,$rootScope,$scope,Authentication,Menus,CardsBread,DecksBread,PcsBread){$scope.authentication=Authentication,$scope.isCollapsed=!1,$scope.menu=Menus.getMenu("topbar"),$scope.toggleCollapsibleMenu=function(){$scope.isCollapsed=!$scope.isCollapsed},$scope.$on("$stateChangeSuccess",function(){$scope.isCollapsed=!1}),$scope.browseDecks=function(param){DecksBread.browse(param),$scope.isCollapsed=!1},$scope.browseCampaigns=function(){console.log("stub")},$scope.browsePcs=function(){PcsBread.browse(),$scope.isCollapsed=!1},$scope.browseNpcs=function(){console.log("stub")}}]),angular.module("core").directive("modalDialogWindow",function(){return{restrict:"E",scope:{show:"="},transclude:!0,templateUrl:"../modules/core/views/modal-window.html",link:function(scope,element,attrs){scope.dialogStyle={},attrs.width&&(scope.dialogStyle.width=attrs.width),attrs.height&&(scope.dialogStyle.height=attrs.height),scope.hideModal=function(){scope.show=!1}}}});var coreModule=angular.module("core");coreModule.directive("screenSize",["$rootScope","$window",function($rootScope,$window){return{restrict:"A",link:function(scope,element,attrs){var _windowHeight,_window=angular.element($window),initialize=function(){toggleListeners(!0),setTimeout(function(){onHeightChange()},0)},toggleListeners=function(enable){enable&&(scope.$on("$destroy",onDestroy),_window.on("resize",onHeightChange))},onDestroy=function(enable){toggleListeners(!1)},onHeightChange=function(){_windowHeight=_window.height(),$rootScope.$broadcast("screenSize:onHeightChange",{newHeight:_windowHeight})};angular.element(document).ready(function(){initialize()}),initialize()}}}]),angular.module("core").factory("Bakery",["PanelUtils","demoDeck","Decks","Pcs","Aspects","Traits","Feats","Augments","Items","Origins","Notes",function(PanelUtils,demoDeck,Decks,Pcs,Aspects,Traits,Feats,Augments,Items,Origins,Notes){var service={};return service.Decks=Decks,service.Pcs=Pcs,service.Aspects=Aspects,service.Traits=Traits,service.Feats=Feats,service.Augments=Augments,service.Items=Items,service.Origins=Origins,service.Notes=Notes,service.resource=demoDeck,service.getCardResource=function(cardType){switch(cardType){case"Aspect":return service.Aspects;case"Trait":return service.Traits;case"Feat":return service.Feats;case"Augment":return service.Augments;case"Item":return service.Items;case"Origin":return service.Origins;case"Note":return service.Notes;default:return!1}},service.getNewCardResource=function(panel){switch(panel.panelType){case"Aspect":return new service.Aspects(panel.aspectData);case"Trait":return new service.Traits(panel.traitData);case"Feat":return new service.Feats(panel.featData);case"Augment":return new service.Augments(panel.augmentData);case"Item":return new service.Items(panel.itemData);case"Origin":return new service.Origins(panel.originData);case"Note":return new service.Origins(panel.noteData);default:return!1}},service}]),angular.module("core").factory("CoreVars",["$rootScope",function($rootScope){var service={};service.windowHeight=0,service.experience=0,service.x_dim_em=15,service.y_dim_em=21,service.x_tab_em=3,service.y_tab_em=3,service.x_cover_em=12,service.y_cover_em=18,service.x_dim_px=240,service.y_dim_px=336,service.x_tab_px=48,service.y_tab_px=48,service.x_cover_px=144,service.y_cover_px=192,service.nullPanel={_id:null,x_coord:0,y_coord:0,above:{adjacent:null,overlap:null},below:{adjacent:null,overlap:null},left:{adjacent:null,overlap:null},right:{adjacent:null,overlap:null}},service.cardMoved=!1,service.cardMoving=!1;var moveTimer;return service.modalShown=!1,service.diceBoxShown=!1,service.modalDeckShown=!1,$rootScope.$on("screenSize:onHeightChange",function(event,object){service.windowHeight=object.newHeight}),service.setCardMoving=function(){clearTimeout(moveTimer),service.cardMoving=!0,service.cardMoved=!0,moveTimer=setTimeout(function(){service.cardMoving=!1,$rootScope.$broadcast("CoreVars:getDeckWidth")},800)},service.hideModal=function(){service.modalShown=!1,service.diceBoxShown=!1,service.modalDeckShown=!1},service}]),angular.module("core").factory("DataSRVC",[function($rootScope){var service={};return service.sexArray=["---","Male","Female"],service.diceList=[{order:1,name:"d__",sides:0,image:"modules/core/img/d___.png"},{order:2,name:"d4",sides:4,image:"modules/core/img/d_04.png"},{order:3,name:"d6",sides:6,image:"modules/core/img/d_06.png"},{order:4,name:"d6",sides:6,image:"modules/core/img/d_06.png"},{order:5,name:"d8",sides:8,image:"modules/core/img/d_08.png"},{order:6,name:"d8",sides:8,image:"modules/core/img/d_08.png"},{order:7,name:"d10",sides:10,image:"modules/core/img/d_10.png"},{order:8,name:"d10",sides:10,image:"modules/core/img/d_10.png"},{order:9,name:"d12",sides:12,image:"modules/core/img/d_12.png"}],service.aspectTypes=["Archetype","Allegiance","Race"],service.targetTypes=["Utility","Close","Close Area","Distant","Distant Area"],service.closeDetails=["1/1","1/2","1/3","1/4","2/1","2/2","2/3","2/4","3/1","3/2","3/3","3/4","4/1","4/2","4/3"],service.closeAreaDetails=["2x2","3x3","4x4","5x5"],service.distantDetails=["4/1","6/1","8/1","10/1","12/1","14/1","16/1","18/1","20/1","22/1","24/1"],service.distantAreaDetails=["8/2x2","10/2x2","12/2x2","16/2x2","10/3x3","12/3x3","16/3x3","20/3x3","12/4x4","16/4x4","20/4x4"],service.actionKeywords=["Default","Single-use","Thrown","Reflexive","Melee","Ranged","Evocation","Invocation"],service.actionFrequency=["Free","Count: 1","Count: 2","Count: 3","Count: 4","Count: 5","Disruptive","Responsive"],service.dice=["1d4","1d6","1d8","1d10","1d12"],service.abilities=["STR","PHY","FLE","DEX","ACU","INT","WIS","CHA"],service.attackTypes=["Melee","Ranged","Evocation","Invocation"],service.defenseTypes=["Block","Dodge","Alertness","Tenacity"],service.prerequisites=["1d10 STR","1d10 PHY","1d10 FLE","1d10 DEX","1d10 ACU","1d10 INT","1d10 WIS","1d10 CHA"],service.itemTypes=["Melee","Melee / Ranged","Melee / Invocation","Ranged","Ranged / Melee","Ranged / Evocation","Evocation","Evocation / Invocation","Evocation / Ranged","Invocation","Invocation / Evocation","Invocation / Melee"],service.itemSlots=["One-handed","Two-handed","One-handed or Paired","One-handed or Two-handed","Armor","Shield","Gloves","Boots","Cloak","Amulet","Ring","Belt","Helmet","Consumable","Provision"],service}]),angular.module("core").factory("demoDeck",[function(){return{dependencies:[],deckType:"",deckSize:3,cardList:[{_id:"DC1",panelType:"deckDemo",x_coord:0,y_coord:0,x_dim:18,y_dim:21,above:{adjacent:null,overlap:null},below:{adjacent:null,overlap:null},left:{adjacent:null,overlap:null},right:{adjacent:"DC2",overlap:null},content:"Here is a basic demonstration of a card-deck layout. While additional features may be accessed via the menu bar, this simple demo serves to show how card-objects may be manipulated by the user, much the same as you might a physical deck of cards."},{_id:"DC2",panelType:"deckDemo",x_coord:18,y_coord:0,x_dim:12,y_dim:21,above:{adjacent:null,overlap:null},below:{adjacent:null,overlap:null},left:{adjacent:"DC1",overlap:null},right:{adjacent:"DC3",overlap:null},content:"For starters, cards can be moved around freely, automatically returning to their position unless moved to a new position."},{_id:"DC3",panelType:"deckDemo",x_coord:30,y_coord:0,x_dim:15,y_dim:21,above:{adjacent:null,overlap:null},below:{adjacent:null,overlap:null},left:{adjacent:"DC2",overlap:null},right:{adjacent:"DC4",overlap:null},content:"Note that the content of each card may vary, and has no relation whatsoever to its actual position. Click again to cover it back up."},{_id:"DC4",panelType:"deckDemo",x_coord:45,y_coord:0,x_dim:15,y_dim:21,above:{adjacent:null,overlap:null},below:{adjacent:null,overlap:null},left:{adjacent:"DC3",overlap:null},right:{adjacent:"DC5",overlap:null},content:"Cards may be stacked vertically. Click on an covered card to uncover it."},{_id:"DC5",panelType:"deckDemo",x_coord:60,y_coord:0,x_dim:15,y_dim:21,above:{adjacent:null,overlap:null},below:{adjacent:null,overlap:null},left:{adjacent:"DC4",overlap:null},right:{adjacent:"DC6",overlap:null},content:"Cards can also be stacked horizontally, but only if they are not already stacked vertically."},{_id:"DC6",panelType:"deckDemo",x_coord:75,y_coord:0,x_dim:15,y_dim:21,above:{adjacent:null,overlap:null},below:{adjacent:null,overlap:null},left:{adjacent:"DC5",overlap:null},right:{adjacent:"DC7",overlap:null},content:"Both vertical and horizontal stacks may be reordered as a single entity."},{_id:"DC7",panelType:"deckDemo",x_coord:90,y_coord:0,x_dim:15,y_dim:21,above:{adjacent:null,overlap:null},below:{adjacent:null,overlap:null},left:{adjacent:"DC6",overlap:null},right:{adjacent:"DC8",overlap:null},content:"The content of each card can also be modified by the user (TODO: add input field)."},{_id:"DC8",panelType:"deckDemo",x_coord:105,y_coord:0,x_dim:15,y_dim:21,above:{adjacent:null,overlap:null},below:{adjacent:null,overlap:null},left:{adjacent:"DC7",overlap:null},right:{adjacent:null,overlap:null},content:'More coming soon! Recently refactored panel "getter" and "setter" methods to return a specific panel based upon its unique objectId, instead of its x/y coordinates. This should allow for more reliable and flexible stacking, including the possibility of overlapping horizontal and vertical stacks.'}]}}]),angular.module("core").service("Menus",[function(){this.defaultRoles=["*"],this.menus={};var shouldRender=function(user){if(!user)return this.isPublic;if(~this.roles.indexOf("*"))return!0;for(var userRoleIndex in user.roles)for(var roleIndex in this.roles)if(this.roles[roleIndex]===user.roles[userRoleIndex])return!0;return!1};this.validateMenuExistance=function(menuId){if(menuId&&menuId.length){if(this.menus[menuId])return!0;throw new Error("Menu does not exists")}throw new Error("MenuId was not provided")},this.getMenu=function(menuId){return this.validateMenuExistance(menuId),this.menus[menuId]},this.addMenu=function(menuId,isPublic,roles){return this.menus[menuId]={isPublic:isPublic||!1,roles:roles||this.defaultRoles,items:[],shouldRender:shouldRender},this.menus[menuId]},this.removeMenu=function(menuId){this.validateMenuExistance(menuId),delete this.menus[menuId]},this.addMenuItem=function(menuId,menuItemTitle,menuItemURL,menuItemType,menuItemUIRoute,isPublic,roles,position){return this.validateMenuExistance(menuId),this.menus[menuId].items.push({title:menuItemTitle,link:menuItemURL,menuItemType:menuItemType||"item",menuItemClass:menuItemType,uiRoute:menuItemUIRoute||"/"+menuItemURL,isPublic:null===isPublic||"undefined"==typeof isPublic?this.menus[menuId].isPublic:isPublic,roles:null===roles||"undefined"==typeof roles?this.menus[menuId].roles:roles,position:position||0,items:[],shouldRender:shouldRender}),this.menus[menuId]},this.addSubMenuItem=function(menuId,rootMenuItemURL,menuItemTitle,menuItemURL,menuItemUIRoute,isPublic,roles,position){this.validateMenuExistance(menuId);for(var itemIndex in this.menus[menuId].items)this.menus[menuId].items[itemIndex].link===rootMenuItemURL&&this.menus[menuId].items[itemIndex].items.push({title:menuItemTitle,link:menuItemURL,uiRoute:menuItemUIRoute||"/"+menuItemURL,isPublic:null===isPublic||"undefined"==typeof isPublic?this.menus[menuId].items[itemIndex].isPublic:isPublic,roles:null===roles||"undefined"==typeof roles?this.menus[menuId].items[itemIndex].roles:roles,position:position||0,shouldRender:shouldRender});return this.menus[menuId]},this.removeMenuItem=function(menuId,menuItemURL){this.validateMenuExistance(menuId);for(var itemIndex in this.menus[menuId].items)this.menus[menuId].items[itemIndex].link===menuItemURL&&this.menus[menuId].items.splice(itemIndex,1);return this.menus[menuId]},this.removeSubMenuItem=function(menuId,submenuItemURL){this.validateMenuExistance(menuId);for(var itemIndex in this.menus[menuId].items)for(var subitemIndex in this.menus[menuId].items[itemIndex].items)this.menus[menuId].items[itemIndex].items[subitemIndex].link===submenuItemURL&&this.menus[menuId].items[itemIndex].items.splice(subitemIndex,1);return this.menus[menuId]},this.addMenu("topbar")}]),angular.module("core").factory("mockDataBuilder",function(){var service={};return service.newMockData=function(){var mockData={};return mockData.aspect_1={_id:"aspect_1_id",panelType:"Aspect",aspectData:{name:"Aspect the First",cardType:"Aspect",cardNumber:1}},mockData.aspect_2={_id:"aspect_2_id",panelType:"Aspect",aspectData:{name:"Aspect the Second",cardType:"Aspect",cardNumber:2}},mockData.aspect_3={_id:"aspect_3_id",panelType:"Aspect",aspectData:{name:"Aspect the Third",cardType:"Aspect",cardNumber:3}},mockData.aspect_4={_id:"aspect_4_id",panelType:"Aspect",aspectData:{name:"Aspect the Fourth",cardType:"Aspect",cardNumber:4}},mockData.aspect_5={_id:"aspect_5_id",panelType:"Aspect",aspectData:{name:"Aspect the Fifth",cardType:"Aspect",cardNumber:5}},mockData.aspect_6={_id:"aspect_6_id",panelType:"Aspect",aspectData:{name:"Aspect the Sixth",cardType:"Aspect",cardNumber:6}},mockData.aspect_7={_id:"aspect_7_id",panelType:"Aspect",aspectData:{name:"Aspect the Seventh",cardType:"Aspect",cardNumber:7}},mockData.aspect_8={_id:"aspect_8_id",panelType:"Aspect",aspectData:{name:"Aspect the Eighth",cardType:"Aspect",cardNumber:8}},mockData.aspectDeck={_id:"aspectDeck_id",dependencies:[],cardList:[mockData.aspect_1,mockData.aspect_2,mockData.aspect_3,mockData.aspect_4,mockData.aspect_5,mockData.aspect_6,mockData.aspect_7,mockData.aspect_8]},mockData.trait_1={_id:"trait_1_id",panelType:"Trait",traitData:{name:"Trait the First",cardType:"Trait",cardNumber:1}},mockData.trait_2={_id:"trait_2_id",panelType:"Trait",traitData:{name:"Trait the Second",cardType:"Trait",cardNumber:2}},mockData.trait_3={_id:"trait_3_id",panelType:"Trait",traitData:{name:"Trait the Third",cardType:"Trait",cardNumber:3}},mockData.trait_4={_id:"trait_4_id",panelType:"Trait",traitData:{name:"Trait the Fourth",cardType:"Trait",cardNumber:4}},mockData.traitDeck={_id:"traitDeck_id",dependencies:[{_id:"aspectDeck_id"}],cardList:[mockData.trait_1,mockData.trait_2,mockData.trait_3,mockData.trait_4]},mockData.feat_1={_id:"feat_1_id",panelType:"Feat",x_coord:0,y_coord:0,above:{adjacent:null,overlap:null},below:{adjacent:null,overlap:null},left:{adjacent:null,overlap:null},right:{adjacent:"feat_2_id",overlap:null},featData:{name:"Feat the First",cardType:"Feat",cardNumber:1}},mockData.feat_2={_id:"feat_2_id",panelType:"Feat",x_coord:15,y_coord:0,above:{adjacent:null,overlap:"feat_3_id"},below:{adjacent:null,overlap:null},left:{adjacent:"feat_1_id",overlap:null},right:{adjacent:null,overlap:null},featData:{name:"Feat the Second",cardType:"Feat",cardNumber:2}},mockData.feat_3={_id:"feat_3_id",panelType:"Feat",x_coord:15,y_coord:3,above:{adjacent:null,overlap:null},below:{adjacent:null,overlap:"feat_2_id"},left:{adjacent:null,overlap:null},right:{adjacent:"feat_4_id",overlap:null},featData:{name:"Feat the Third",cardType:"Feat",cardNumber:3}},mockData.feat_4={_id:"feat_4_id",panelType:"Feat",x_coord:30,y_coord:0,above:{adjacent:null,overlap:"feat_5_id"},below:{adjacent:null,overlap:null},left:{adjacent:"feat_3_id",overlap:null},right:{adjacent:null,overlap:null},featData:{name:"Feat the Fourth",cardType:"Feat",cardNumber:4}},mockData.feat_5={_id:"feat_5_id",panelType:"Feat",x_coord:30,y_coord:3,above:{adjacent:null,overlap:"feat_6_id"},below:{adjacent:null,overlap:"feat_4_id"},left:{
adjacent:null,overlap:null},right:{adjacent:null,overlap:null},featData:{name:"Feat the Fifth",cardType:"Feat",cardNumber:5}},mockData.feat_6={_id:"feat_6_id",panelType:"Feat",x_coord:30,y_coord:6,above:{adjacent:null,overlap:null},below:{adjacent:null,overlap:"feat_5_id"},left:{adjacent:null,overlap:null},right:{adjacent:"feat_7_id",overlap:null},featData:{name:"Feat the Sixth",cardType:"Feat",cardNumber:6}},mockData.feat_7={_id:"feat_7_id",panelType:"Feat",x_coord:45,y_coord:0,above:{adjacent:null,overlap:"feat_8_id"},below:{adjacent:null,overlap:null},left:{adjacent:"feat_6_id",overlap:null},right:{adjacent:null,overlap:null},featData:{name:"Feat the Seventh",cardType:"Feat",cardNumber:7}},mockData.feat_8={_id:"feat_8_id",panelType:"Feat",x_coord:45,y_coord:3,above:{adjacent:null,overlap:"feat_9_id"},below:{adjacent:null,overlap:"feat_7_id"},left:{adjacent:null,overlap:null},right:{adjacent:null,overlap:null},featData:{name:"Feat the Eighth",cardType:"Feat",cardNumber:8}},mockData.feat_9={_id:"feat_9_id",panelType:"Feat",x_coord:45,y_coord:6,above:{adjacent:null,overlap:"feat_10_id"},below:{adjacent:null,overlap:"feat_8_id"},left:{adjacent:null,overlap:null},right:{adjacent:null,overlap:null},featData:{name:"Feat the Ninth",cardType:"Feat",cardNumber:9}},mockData.feat_10={_id:"feat_10_id",panelType:"Feat",x_coord:45,y_coord:9,above:{adjacent:null,overlap:null},below:{adjacent:null,overlap:"feat_9_id"},left:{adjacent:null,overlap:null},right:{adjacent:null,overlap:null},featData:{name:"Feat the Tenth",cardType:"Feat",cardNumber:10}},mockData.featDeck={_id:"featDeck_id",dependencies:[],cardList:[mockData.feat_1,mockData.feat_2,mockData.feat_3,mockData.feat_4,mockData.feat_5,mockData.feat_6,mockData.feat_7,mockData.feat_8,mockData.feat_9,mockData.feat_10]},mockData},service}),angular.module("core").factory("Socket",["socketFactory",function(socketFactory){var mSocket=socketFactory({ioSocket:socket});return mSocket}]),angular.module("core").factory("syncLoop",[function(){return function(iterations,process,exit){var index=0,done=!1,shouldExit=!1,loop={next:function(){return done&&shouldExit&&exit?exit():void(iterations>index?(index++,process(loop)):(done=!0,exit&&exit()))},iteration:function(){return index-1},"break":function(end){done=!0,shouldExit=end}};return loop.next(),loop}}]),angular.module("decks").factory("DecksBread",["$rootScope","syncLoop","Bakery","PanelUtils","DeckUtils","CardsBread",function($rootScope,syncLoop,Bakery,PanelUtils,DeckUtils,CardsBread){var service={};return service.browseAspects=function(deck){Bakery.resource.archetypeList=[],Bakery.resource.allegianceList=[],Bakery.resource.raceList=[],Bakery.Aspects.query({deckId:deck._id},function(response){for(var i=0;i<response.length;i++)"Archetype"===response[i].aspectType?Bakery.resource.archetypeList.push(response[i]):"Allegiance"===response[i].aspectType?Bakery.resource.allegianceList.push(response[i]):"Race"===response[i].aspectType&&Bakery.resource.raceList.push(response[i])})},service.browseDependencies=function(){Bakery.Decks.query({deckType:"Aspect"},function(response){Bakery.dependencyDecks=response})},service.browse=function(param){Bakery.resource={},param?Bakery.Decks.query(param,function(response){response.unshift({_id:"builderOptionsId",panelType:"builderOptions",x_dim:18,y_dim:21}),Bakery.resource.cardList=response,DeckUtils.setCardList(Bakery.resource.cardList)}):Bakery.Decks.list(function(response){response.unshift({_id:"builderOptionsId",panelType:"builderOptions",x_dim:18,y_dim:21}),Bakery.resource.cardList=response,DeckUtils.setCardList(Bakery.resource.cardList)})},service.read=function(deck){Bakery.Decks.get({deckId:deck._id},function(response){if(Bakery.resource=response,"Aspect"!==response.deckType){service.browseDependencies();for(var i=0;i<response.dependencies.length;i++)service.browseAspects(response.dependencies[i])}console.log(response)})},service.edit=function(deck,editCards,loadDeck){var _deck=new Bakery.Decks(deck);_deck.$update(function(response){if(editCards){for(var i=0;i<deck.cardList.length;i++){var panel=deck.cardList[i];CardsBread.edit(panel)}$rootScope.$broadcast("Bakery: deckSaved")}loadDeck&&(Bakery.resource=response)},function(errorResponse){console.log(errorResponse)})},service.add=function(type,size){var deck=new Bakery.Decks({name:type+" Deck",deckType:type,deckSize:size,cardList:[{panelType:"deckOptions",x_coord:0,y_coord:0,x_dim:18,y_dim:21,above:{adjacent:null,overlap:null},below:{adjacent:null,overlap:null},left:{adjacent:null,overlap:null},right:{adjacent:null,overlap:null}}]});deck.$save(function(){var cardNumber=1;syncLoop(size,function(loop){CardsBread.add(deck,null,cardNumber,function(response){deck.$update(function(){var previous=deck.cardList[cardNumber-1],current=deck.cardList[cardNumber];previous.right.adjacent=current._id,current.left.adjacent=previous._id,cardNumber++,loop.next()})})},function(){service.edit(deck,!1,!0),"Aspect"!==type&&service.browseDependencies()})})},service["delete"]=function(resource,deck){resource&&DeckUtils.collapseDeck(resource.cardList,deck),deck.$remove(function(response){resource&&PanelUtils.removePanel(resource.cardList,deck)}).then(function(response){resource&&DeckUtils.setDeckSize(resource)}).then(function(response){})},service}]),angular.module("decks").factory("Decks",["$resource",function($resource){return $resource("deck/:deckId",{deckId:"@_id"},{update:{method:"PUT"},list:{url:"/decks",method:"GET",isArray:!0},query:{url:"/decks/:deckType",method:"GET",isArray:!0,params:{deckType:"deckType"}}})}]),angular.module("move").directive("cardPanel",["$document","$parse","$rootScope","$window","MoveHub","Bakery","CoreVars","checkEdge","onCardMove","PanelUtils","DeckUtils",function($document,$parse,$rootScope,$window,MoveHub,Bakery,CoreVars,checkEdge,onCardMove,PanelUtils,DeckUtils){return{restrict:"A",templateUrl:"../modules/core/views/card-panel.html",link:function(scope,element,attrs){Array.min=function(array){return Math.min.apply(Math,array)};var _startX,_startY,_mouseX,_mouseY,_moveX,_moveY,_panelX,_panelY,_startCol,_mouseCol,_startRow,_mouseRow,_moveTimer,_dropdownOpen=!1,_panel=$parse(attrs.panel)||null,_hasTouch="ontouchstart"in window,_pressEvents="touchstart mousedown",_moveEvents="touchmove mousemove",_releaseEvents="touchend mouseup",_pressTimer=null,initialize=function(){element.attr("draggable","false"),toggleListeners(!0),$document.ready(function(){onHeightChange()})},toggleListeners=function(enable){enable&&(scope.$on("$destroy",onDestroy),scope.$watch(attrs.panel,onCardChange),scope.$on("screenSize:onHeightChange",onHeightChange),scope.$on("cardPanel:onPressCard",onPressCard),scope.$on("cardPanel:onMoveCard",onMoveCard),scope.$on("cardPanel:onReleaseCard",onReleaseCard),scope.$on("deckStack:onMouseLeave",onMouseLeave),scope.$on("CardsCtrl:onDropdown",onDropdown),scope.$watch("panel.x_coord",resetPosition),scope.$watch("panel.y_coord",resetPosition),element.on(_pressEvents,onPress),_hasTouch||"img"!==element[0].nodeName.toLowerCase()||element.on("mousedown",function(){return!1}))},onDestroy=function(enable){toggleListeners(!1)},onCardChange=function(newVal,oldVal){_panel=newVal,element.css({top:"0",left:"-21em"}),setTimeout(function(){setPosition()},0)},onDropdown=function(event,object){_dropdownOpen=object.isOpen},getElementFontSize=function(){return parseFloat($window.getComputedStyle(element[0],null).getPropertyValue("font-size"))},convertEm=function(value){return value*getElementFontSize()},onHeightChange=function(event,object){CoreVars.x_dim_px=convertEm(15),CoreVars.y_dim_px=convertEm(21),CoreVars.x_tab_px=convertEm(3),CoreVars.y_tab_px=convertEm(3),CoreVars.x_cover_px=convertEm(12),CoreVars.y_cover_px=convertEm(18),setPosition()},resetPosition=function(newVal,oldVal){element.hasClass("card-moving")&&setPosition()},setPosition=function(){element.css({top:_panel.y_coord+"em",left:_panel.x_coord+"em"})},onPress=function(event){_dropdownOpen?$document.triggerHandler("click"):_hasTouch?(cancelPress(),_pressTimer=setTimeout(function(){cancelPress(),onLongPress(event)},100),$document.on(_moveEvents,cancelPress),$document.on(_releaseEvents,cancelPress)):_hasTouch||onLongPress(event)},cancelPress=function(){clearTimeout(_pressTimer),$document.off(_moveEvents,cancelPress),$document.off(_releaseEvents,cancelPress)},onLongPress=function(event){_startX=event.pageX||event.touches[0].pageX,_startY=event.pageY||event.touches[0].pageY,_moveX=0,_moveY=0,$document.on(_moveEvents,onMove),$document.on(_releaseEvents,onRelease),element.removeClass("card-moving"),PanelUtils.getCluster(Bakery.resource.cardList,_panel,function(stackArray){for(var i=0;i<stackArray.length;i++)stackArray[i].dragging=!0}),$rootScope.$broadcast("cardPanel:onPressCard",{startX:_startX,startY:_startY,panel:_panel})},onPressCard=function(event,object){_startCol=convertEm(_panel.x_coord),_startRow=convertEm(_panel.y_coord),_panel.dragging||element.addClass("card-moving")},onMove=function(event){event.preventDefault(),_mouseX=event.pageX||event.touches[0].pageX,_mouseY=event.pageY||event.touches[0].pageY,_mouseCol=convertEm(_panel.x_coord),_mouseRow=convertEm(_panel.y_coord),_moveX=_mouseX-_startX,_moveY=_mouseY-_startY,_panelX=_moveX+_startCol-(_startCol-_mouseCol),_panelY=_moveY+_startRow-(_startRow-_mouseRow),$rootScope.$broadcast("cardPanel:onMoveCard",{mouseX:_mouseX,mouseY:_mouseY,moveX:_moveX,moveY:_moveY,panelX:_panelX,panelY:_panelY,panel:_panel})},onMoveCard=function(event,object){object.slot=_panel,object.offset=element.offset(),object.emPx=convertEm(1),element.hasClass("card-moving")?onCardMove(object):element.css({left:object.moveX+_startCol+"px",top:object.moveY+_startRow+"px"})},onRelease=function(){if($document.off(_moveEvents,onMove),$document.off(_releaseEvents,onRelease),$rootScope.$broadcast("cardPanel:onReleaseCard",{panel:_panel}),_moveX<=convertEm(2)&&_moveY<=convertEm(2)){var _offset=element.offset(),_nearest=checkEdge.crossing(_panel,_offset.left,_offset.top,_startX,_startY,convertEm(1));MoveHub.triggerOverlap(_panel,_nearest)}CoreVars.cardMoved=!1;for(var _deck=Bakery.resource.cardList,i=0;i<_deck.length;i++)_deck[i].dragging=!1},onReleaseCard=function(event,object){element.addClass("card-moving"),setTimeout(function(){setPosition()},0),clearTimeout(_moveTimer),_moveTimer=setTimeout(function(){element.removeClass("card-moving")},600)},onMouseLeave=function(){$document.off(_moveEvents,onMove),$document.off(_releaseEvents,onRelease),$rootScope.$broadcast("cardPanel:onReleaseCard",{panel:_panel})};initialize()}}}]),angular.module("move").directive("deckStack",["$rootScope","$window","Bakery","DeckUtils","MoveHub",function($rootScope,$window,Bakery,DeckUtils,MoveHub){return{restrict:"A",link:function(scope,element,attrs){var pressed=!1,initialize=function(){toggleListeners(!0)},toggleListeners=function(enable){enable&&(scope.$on("$destroy",onDestroy),element.on("mouseleave",onMouseLeave),scope.$on("screenSize:onHeightChange",onHeightChange),scope.$on("DeckUtils:setDeckWidth",setDeckWidth),scope.$on("cardPanel:onPressCard",onPress),scope.$on("cardPanel:onReleaseCard",onRelease),scope.$on("cardPanel:onMoveCard",onMoveCard))},onDestroy=function(enable){toggleListeners(!1)},onHeightChange=function(event,object){var windowHeight=object.newHeight-50;element.css({height:windowHeight+"px"})},setDeckWidth=function(){var deckWidth=DeckUtils.getDeckWidth(Bakery.resource.cardList);element.css({width:deckWidth+"em"})},getElementFontSize=function(){return parseFloat($window.getComputedStyle(element[0],null).getPropertyValue("font-size"))},convertEm=function(value){return value*getElementFontSize()},onPress=function(){pressed=!0},onRelease=function(){pressed=!1},onMoveCard=function(event,object){var deckOffset=element.offset(),deckWidth=DeckUtils.getDeckWidth(Bakery.resource.cardList),deckLeftEdge=deckOffset.left,deckRightEdge=convertEm(deckWidth+3);object.mouseX<=deckLeftEdge?MoveHub.unstackLeft(object.panel):object.mouseX>=deckRightEdge&&MoveHub.unstackRight(object.panel)},onMouseLeave=function(event){pressed&&$rootScope.$broadcast("deckStack:onMouseLeave")};initialize()}}}]),angular.module("move").factory("checkEdge",["CoreVars",function(CoreVars){var service={};return service.crossing=function(panel,slotX,slotY,mouseX,mouseY,emPx){var _belowEdge,_leftEdge,_cover_px=3*emPx,_x_dim_px=panel.x_dim*emPx,_y_dim_px=panel.y_dim*emPx,_aboveEdge=slotY,_rightEdge=slotX+_x_dim_px;if(_belowEdge=panel.below.overlap?slotY+_cover_px:slotY+_y_dim_px,_leftEdge=panel.left.overlap?slotX+_x_dim_px-_cover_px:slotX,mouseX>=_leftEdge&&_rightEdge>=mouseX&&mouseY>=_aboveEdge&&_belowEdge>=mouseY){var _above=mouseY-_aboveEdge,_below=_belowEdge-mouseY,_left=mouseX-_leftEdge,_right=_rightEdge-mouseX,_edges=[_above,_below,_left,_right],_closestEdge=Math.min.apply(Math.min,_edges),_edgeNames=["above","below","left","right"],_edgeName=_edgeNames[_edges.indexOf(_closestEdge)];return _edgeName}return!1},service}]),angular.module("move").factory("DeckUtils",["$rootScope","CoreVars","PanelUtils","setPanelPosition",function($rootScope,CoreVars,PanelUtils,setPanelPosition){var service={};return service.getRefArray=function(cardList){var _first=PanelUtils.getFirst(cardList),_index=_first.index,_panel=_first.panel,_refArray=[_index];for(_panel||console.log(_refArray);_panel.below.adjacent||_panel.below.overlap||_panel.right.adjacent||_panel.right.overlap;)_panel.below.adjacent?_index=PanelUtils.getPanelIndex(cardList,_panel.below.adjacent):_panel.below.overlap?_index=PanelUtils.getPanelIndex(cardList,_panel.below.overlap):_panel.right.adjacent?_index=PanelUtils.getPanelIndex(cardList,_panel.right.adjacent):_panel.right.overlap&&(_index=PanelUtils.getPanelIndex(cardList,_panel.right.overlap)),_refArray.push(_index),_panel=cardList[_index];return _refArray},service.setCardList=function(cardList){for(var i=0;i<cardList.length;i++){var _previous=cardList[i-1]||null,_current=cardList[i],_next=cardList[i+1]||null;_current.dragging=!1,_current.locked=!1,_current.above={adjacent:null,overlap:null},_current.below={adjacent:null,overlap:null},_current.left={adjacent:null,overlap:null},_current.right={adjacent:null,overlap:null},_previous&&(_current.left.adjacent=_previous._id),_next&&(_current.right.adjacent=_next._id)}setPanelPosition(cardList),$rootScope.$broadcast("cardPanel:onReleaseCard")},service.expandDeck=function(cardList,panel){for(var panel_x_coord=panel.x_coord,i=(panel.y_coord,0);i<cardList.length;i++){var slot=cardList[i],slotData=PanelUtils.getPanelData(slot);slot!==panel&&slot.x_coord>=panel_x_coord&&(slot.x_coord+=15,slotData.cardNumber++)}$rootScope.$broadcast("cardPanel:onReleaseCard")},service.collapseDeck=function(cardList,panel){var _prev=(service.getRefArray(cardList),PanelUtils.getPrev(cardList,panel._id).panel),_next=PanelUtils.getNext(cardList,panel._id).panel;PanelUtils.hasAbove(panel)?PanelUtils.hasBelow(panel)?panel.above.overlap&&panel.below.overlap?PanelUtils.setOverlapVertical(_prev,_next):PanelUtils.setAdjacentVertical(_prev,_next):PanelUtils.hasRight(panel)&&(panel.right.overlap?PanelUtils.setOverlapHorizontal(_prev,_next):PanelUtils.setAdjacentHorizontal(_prev,_next)):PanelUtils.hasLeft(panel)&&(PanelUtils.hasBelow(panel)?panel.left.overlap?PanelUtils.setOverlapHorizontal(_prev,_next):PanelUtils.setAdjacentHorizontal(_prev,_next):PanelUtils.hasRight(panel)&&(panel.left.overlap&&panel.right.overlap?PanelUtils.setOverlapHorizontal(_prev,_next):PanelUtils.setAdjacentHorizontal(_prev,_next))),setPanelPosition(cardList),$rootScope.$broadcast("cardPanel:onReleaseCard")},service.setDeckSize=function(resource){var _length=resource.cardList.length-1;resource.deckSize=_length;for(var i=0;i<resource.cardList.length;i++){var panel=resource.cardList[i],panelData=PanelUtils.getPanelData(panel);panelData.deckSize=_length}},service.getDeckWidth=function(cardList){var lastPanel=PanelUtils.getLast(cardList);return lastPanel.panel.x_coord+15},service.setDeckWidth=function(cardList){var _deckWidth=service.getDeckWidth(cardList);$rootScope.$broadcast("DeckUtils:setDeckWidth",{deckWidth:_deckWidth})},service}]),angular.module("move").factory("MoveHub",["$rootScope","CoreVars","Bakery","PanelUtils","DeckUtils","switchHorizontal","switchVertical","stackOver","stackUnder","unstackCard","toggleOverlap",function($rootScope,CoreVars,Bakery,PanelUtils,DeckUtils,switchHorizontal,switchVertical,stackOver,stackUnder,unstackCard,toggleOverlap){var service={};$rootScope.$on("CoreVars:getDeckWidth",DeckUtils.setDeckWidth(Bakery.resource.cardList));var getCardList=function(){return Bakery.resource.cardList};return service.triggerOverlap=function(panel,nearest){if(!CoreVars.cardMoved){var _cardList=getCardList();toggleOverlap(_cardList,panel._id,nearest)}},service.moveHorizontal=function(slot,panel){var _deck=getCardList();console.log("moveHorizontal"),panel.above.adjacent?unstackCard(_deck,slot,panel):switchHorizontal(_deck,slot,panel)},service.moveDiagonalUp=function(slot,panel){var _deck=getCardList();console.log("moveDiagonalUp"),PanelUtils.isInCluster(_deck,panel._id)?switchHorizontal(_deck,slot,panel):panel.above.overlap?unstackCard(_deck,slot,panel):stackUnder(_deck,slot,panel)},service.moveDiagonalDown=function(slot,panel){var _deck=getCardList();console.log("moveDiagonalDown"),PanelUtils.isInCluster(_deck,panel._id)?switchHorizontal(_deck,slot,panel):panel.above.adjacent?unstackCard(_deck,slot,panel):stackOver(_deck,slot,panel)},service.moveVertical=function(slot,panel){var _deck=getCardList();switchVertical(_deck,slot,panel)},service.unstackLeft=function(panel){if(panel.y_coord>0){console.log("unstackLeft");var _deck=getCardList(),unstack_coord=-CoreVars.x_dim_em;unstackCard(_deck,{x_coord:unstack_coord},panel)}},service.unstackRight=function(panel){if(panel.y_coord>0){console.log("unstackRight");var _deck=getCardList(),_last=PanelUtils.getLast(_deck),unstack_coord=_last.panel.x_coord+CoreVars.x_dim_em;unstackCard(_deck,{x_coord:unstack_coord},panel)}},service}]),angular.module("move").factory("onCardMove",["CoreVars","MoveHub","checkEdge",function(CoreVars,MoveHub,checkEdge){return function(object){if(!CoreVars.cardMoving){var mouseX=object.mouseX,mouseY=object.mouseY,moveY=(object.moveX,object.moveY),vectorX=Math.abs(object.moveX),vectorY=Math.abs(object.moveY),emPx=object.emPx,slot=object.slot,slot_x=slot.x_coord+slot.x_dim,slot_y=slot.y_coord+slot.y_dim,slot_x_px=object.offset.left,slot_y_px=object.offset.top,slot_x_overlap=slot.left.overlap||slot.right.overlap,slot_y_overlap=slot.above.overlap||slot.below.overlap,panel=object.panel,panel_x=panel.x_coord+panel.x_dim,panel_y=panel.y_coord+panel.y_dim,panel_x_overlap=panel.left.overlap||panel.right.overlap,panel_y_overlap=panel.above.overlap||panel.below.overlap,changeX=Math.abs(panel_x-slot_x),changeY=Math.abs(panel_y-slot_y),crossingResult=checkEdge.crossing(slot,slot_x_px,slot_y_px,mouseX,mouseY,emPx);!crossingResult||0===changeX&&0===changeY||("above"===crossingResult?vectorX>0&&!slot_y_overlap&&!slot_x_overlap&&!panel_x_overlap?(console.log("cardPanel:moveDiagonalUp"),MoveHub.moveDiagonalUp(slot,panel)):0!==changeX||panel_y_overlap?(console.log("cardPanel:moveHorizontal"),MoveHub.moveHorizontal(slot,panel)):(console.log("cardPanel:moveVertical"),MoveHub.moveVertical(slot,panel)):"below"===crossingResult?changeX>0?(console.log("changeX: "+changeX),console.log("cardPanel:moveDiagonalDown"),MoveHub.moveDiagonalDown(slot,panel)):0!==changeX||panel_y_overlap?(console.log("cardPanel:moveHorizontal"),MoveHub.moveHorizontal(slot,panel)):(console.log("cardPanel:moveVertical"),MoveHub.moveVertical(slot,panel)):("left"===crossingResult||"right"===crossingResult)&&(2*vectorY>vectorX?0>moveY?(console.log("cardPanel:moveDiagonalUp"),MoveHub.moveDiagonalUp(slot,panel)):moveY>0&&(console.log("cardPanel:moveDiagonalDown"),MoveHub.moveDiagonalDown(slot,panel)):(console.log("cardPanel:moveHorizontal"),MoveHub.moveHorizontal(slot,panel))))}}}]),angular.module("move").factory("PanelUtils",["$rootScope","$resource","CoreVars",function($rootScope,$resource,CoreVars){var service={};return service.hasAbove=function(panel){return panel.above.adjacent||panel.above.overlap?!0:!1},service.hasBelow=function(panel){return panel.below.adjacent||panel.below.overlap?!0:!1},service.hasLeft=function(panel){return panel.left.adjacent||panel.left.overlap?!0:!1},service.hasRight=function(panel){return panel.right.adjacent||panel.right.overlap?!0:!1},service.hasPrev=function(panel){return service.hasAbove(panel)||service.hasLeft(panel)?!0:!1},service.hasNext=function(panel){return service.hasBelow(panel)||service.hasRight(panel)?!0:!1},service.isInCluster=function(cardList,panelId){var _panel=service.getPanel(cardList,panelId),_prev=null,_next=null,_inRange=!1,_inStack=!1,_length=cardList.length,_prevCount=0,_nextCount=0;if(_panel.above.overlap?(_prev=service.getPanel(cardList,_panel.above.overlap),_inStack=!0):_panel.left.overlap&&(_prev=service.getPanel(cardList,_panel.left.overlap),_inRange=!0),_panel.below.overlap?(_next=service.getPanel(cardList,_panel.below.overlap),_inStack=!0):_panel.right.overlap&&(_next=service.getPanel(cardList,_panel.right.overlap),_inRange=!0),_prev)for(;(_prev.above.overlap||_prev.left.overlap)&&_length>_prevCount;)_prev.above.overlap?(_prev=service.getPanel(cardList,_prev.above.overlap),_inStack=!0):_prev.left.overlap&&(_prev=service.getPanel(cardList,_prev.left.overlap),_inRange=!0),_prevCount++;if(_next)for(;(_next.below.overlap||_next.right.overlap)&&_length>_nextCount;)_next.below.overlap?(_next=service.getPanel(cardList,_next.below.overlap),_inStack=!0):_next.right.overlap&&(_next=service.getPanel(cardList,_next.right.overlap),_inRange=!0),_nextCount++;return _inRange&&_inStack?!0:!1},service.setAdjacentVertical=function(abovePanel,belowPanel){abovePanel.below={adjacent:belowPanel._id,overlap:null},abovePanel.right={adjacent:null,overlap:null},belowPanel.above={adjacent:abovePanel._id,overlap:null},belowPanel.left={adjacent:null,overlap:null}},service.setAdjacentHorizontal=function(leftPanel,rightPanel){leftPanel.below={adjacent:null,overlap:null},leftPanel.right={adjacent:rightPanel._id,overlap:null},rightPanel.above={adjacent:null,overlap:null},rightPanel.left={adjacent:leftPanel._id,overlap:null}},service.setOverlapVertical=function(abovePanel,belowPanel){abovePanel.below={adjacent:null,overlap:belowPanel._id},abovePanel.right={adjacent:null,overlap:null},belowPanel.above={adjacent:null,overlap:abovePanel._id},belowPanel.left={adjacent:null,overlap:null}},service.setOverlapHorizontal=function(leftPanel,rightPanel){leftPanel.below={adjacent:null,overlap:null},leftPanel.right={adjacent:null,overlap:rightPanel._id},rightPanel.above={adjacent:null,overlap:null},rightPanel.left={adjacent:null,overlap:leftPanel._id}},service.getPanel=function(cardList,panelId){for(var _panel=CoreVars.nullPanel,i=0;i<cardList.length;i++)cardList[i]._id===panelId&&(_panel=cardList[i]);return _panel},service.getPanelIndex=function(cardList,panelId){for(var _index=-1,i=0;i<cardList.length;i++)cardList[i]._id===panelId&&(_index=i);return _index},service.getPrev=function(cardList,panelId){var _panel=service.getPanel(cardList,panelId),_prevPanel=CoreVars.nullPanel,_prevIndex=-1;return _panel.above.adjacent?(_prevPanel=service.getPanel(cardList,_panel.above.adjacent),_prevIndex=service.getPanelIndex(cardList,_panel.above.adjacent)):_panel.above.overlap?(_prevPanel=service.getPanel(cardList,_panel.above.overlap),_prevIndex=service.getPanelIndex(cardList,_panel.above.overlap)):_panel.left.adjacent?(_prevPanel=service.getPanel(cardList,_panel.left.adjacent),_prevIndex=service.getPanelIndex(cardList,_panel.left.adjacent)):_panel.left.overlap&&(_prevPanel=service.getPanel(cardList,_panel.left.overlap),_prevIndex=service.getPanelIndex(cardList,_panel.left.overlap)),{panel:_prevPanel,index:_prevIndex}},service.getNext=function(cardList,panelId){var _panel=service.getPanel(cardList,panelId),_nextPanel=CoreVars.nullPanel,_nextIndex=-1;return _panel.below.adjacent?(_nextPanel=service.getPanel(cardList,_panel.below.adjacent),_nextIndex=service.getPanelIndex(cardList,_panel.below.adjacent)):_panel.below.overlap?(_nextPanel=service.getPanel(cardList,_panel.below.overlap),_nextIndex=service.getPanelIndex(cardList,_panel.below.overlap)):_panel.right.adjacent?(_nextPanel=service.getPanel(cardList,_panel.right.adjacent),_nextIndex=service.getPanelIndex(cardList,_panel.right.adjacent)):_panel.right.overlap&&(_nextPanel=service.getPanel(cardList,_panel.right.overlap),_nextIndex=service.getPanelIndex(cardList,_panel.right.overlap)),{panel:_nextPanel,index:_nextIndex}},service.getFirst=function(cardList){for(var _index=0,_panel=CoreVars.nullPanel,i=0;i<cardList.length;i++){var test=cardList[i];service.hasPrev(test)||(_panel=test)}return{index:_index,panel:_panel}},service.getLast=function(cardList){for(var _index=0,_panel=CoreVars.nullPanel,i=0;i<cardList.length;i++){var test=cardList[i];service.hasNext(test)||(_panel=test)}return{index:_index,panel:_panel}},service.getPanelOrder=function(cardList,panelId){for(var _order=0,_panel=service.getFirst(cardList).panel;service.hasNext(_panel)&&_panel._id!==panelId;)_panel.below.adjacent?(_panel=service.getPanel(cardList,_panel.below.adjacent),_order++):_panel.below.overlap?(_panel=service.getPanel(cardList,_panel.below.overlap),_order++):_panel.right.adjacent?(_panel=service.getPanel(cardList,_panel.right.adjacent),_order++):_panel.right.overlap&&(_panel=service.getPanel(cardList,_panel.right.overlap),_order++);return _order},service.getStackStart=function(cardList,panelId){for(var _panel=service.getPanel(cardList,panelId),_count=0;_panel.above.overlap&&_count<cardList.length;)_panel=service.getPanel(cardList,_panel.above.overlap),_count++;return _panel},service.getStackEnd=function(cardList,panelId){for(var _panel=service.getPanel(cardList,panelId),_count=0;_panel.below.overlap&&_count<cardList.length;)_panel=service.getPanel(cardList,_panel.below.overlap),_count++;return _panel},service.getStack=function(cardList,panel,callBack){for(var _panel=service.getStackStart(cardList,panel._id),_panelArray=[_panel],_count=0;_panel.below.overlap&&_count<cardList.length;)_panel=service.getPanel(cardList,_panel.below.overlap),_panelArray.push(_panel);return callBack?void callBack(_panelArray):_panelArray},service.getRangeStart=function(cardList,panelId){for(var _panel=service.getPanel(cardList,panelId),_count=0;(_panel.above.adjacent||_panel.above.overlap||_panel.left.overlap)&&_count<cardList.length;)_panel.above.adjacent?_panel=service.getPanel(cardList,_panel.above.adjacent):_panel.above.overlap?_panel=service.getPanel(cardList,_panel.above.overlap):_panel.left.overlap&&(_panel=service.getPanel(cardList,_panel.left.overlap)),_count++;return _panel},service.getRangeEnd=function(cardList,panelId){for(var _panel=service.getPanel(cardList,panelId),_count=0;(_panel.below.adjacent||_panel.below.overlap||_panel.right.overlap)&&_count<cardList.length;)_panel.below.adjacent?_panel=service.getPanel(cardList,_panel.below.adjacent):_panel.below.overlap?_panel=service.getPanel(cardList,_panel.below.overlap):_panel.right.overlap&&(_panel=service.getPanel(cardList,_panel.right.overlap));return _panel},service.getRange=function(cardList,panel,callBack){for(var _panel=service.getRangeStart(cardList,panel._id),_panelArray=[_panel],_count=0;(_panel.below.adjacent||_panel.below.overlap||_panel.right.overlap)&&_count<cardList.length;)_panel.below.adjacent?(_panel=service.getPanel(cardList,_panel.below.adjacent),_panelArray.push(_panel)):_panel.below.overlap?(_panel=service.getPanel(cardList,_panel.below.overlap),_panelArray.push(_panel)):_panel.right.overlap&&(_panel=service.getPanel(cardList,_panel.right.overlap),_panelArray.push(_panel));return callBack?void callBack(_panelArray):_panelArray},service.getClusterStart=function(cardList,panelId){for(var _panel=service.getPanel(cardList,panelId),_count=0;(_panel.above.overlap||_panel.left.overlap)&&_count<cardList.length;)_panel.left.overlap?_panel=service.getPanel(cardList,_panel.left.overlap):_panel.above.overlap&&(_panel=service.getPanel(cardList,_panel.above.overlap)),_count++;return _panel},service.getClusterEnd=function(cardList,panelId){for(var _panel=service.getPanel(cardList,panelId),_count=0;(_panel.below.overlap||_panel.right.overlap)&&_count<cardList.length;)_panel.right.overlap?_panel=service.getPanel(cardList,_panel.right.overlap):_panel.below.overlap&&(_panel=service.getPanel(cardList,_panel.below.overlap)),_count++;return _panel},service.getCluster=function(cardList,panel,callBack){for(var _panel=service.getClusterStart(cardList,panel._id),_panelArray=[_panel];_panel.below.overlap||_panel.right.overlap;)_panel.below.overlap?(_panel=service.getPanel(cardList,_panel.below.overlap),_panelArray.push(_panel)):_panel.right.overlap&&(_panel=service.getPanel(cardList,_panel.right.overlap),_panelArray.push(_panel));return callBack?void callBack(_panelArray):_panelArray},service.removePanel=function(cardList,panel){for(var i=0;i<cardList.length;i++)cardList[i]===panel&&cardList.splice(i,1)},service.getPanelData=function(panel){switch(panel.panelType){case"Aspect":return panel.aspectData;case"Trait":return panel.traitData;case"Feat":return panel.featData;case"Augment":return panel.augmentData;case"Item":return panel.itemData;case"Origin":return panel.originData;default:return!1}},service.setPanelData=function(panel,cardData){switch(panel.panelType){case"Aspect":panel.aspectData=cardData;break;case"Trait":panel.traitData=cardData;break;case"Feat":panel.featData=cardData;break;case"Augment":panel.augmentData=cardData;break;case"Item":panel.itemData=cardData;break;case"Origin":panel.originData=cardData;break;default:return!1}},service.getCardParams=function(panel){var cardId;switch(panel.panelType){case"Aspect":return cardId=panel.aspectData._id,{aspectId:panel.aspectData._id};case"Trait":return cardId=panel.traitData._id,{traitId:panel.traitData._id};case"Feat":return cardId=panel.featData._id,{featId:panel.featData._id};case"Augment":return cardId=panel.augmentData._id,{augmentId:panel.augmentData._id};case"Item":return cardId=panel.itemData._id,{itemId:panel.itemData._id};case"Origin":return cardId=panel.originData._id,{originId:panel.originData._id};default:return!1}},service}]),angular.module("move").factory("setPanelPosition",["$rootScope","CoreVars","PanelUtils",function($rootScope,CoreVars,PanelUtils,DeckUtils){return function(cardList){for(var _next,_curr=PanelUtils.getFirst(cardList).panel,_last=PanelUtils.getLast(cardList).panel,_continue=!0,_count=0,_length=cardList.length,_x_next=0,_y_next=0,_z_next=100*_length;_continue;)PanelUtils.hasNext(_curr)&&_length>_count?(_curr.x_coord=_x_next,_curr.y_coord=_y_next,_curr.z_coord=_z_next,_curr.below.adjacent?(_next=PanelUtils.getPanel(cardList,_curr.below.adjacent),_y_next+=_curr.y_dim,_x_next+=_curr.x_dim,_x_next-=_next.x_dim,_z_next++):_curr.below.overlap?(_next=PanelUtils.getPanel(cardList,_curr.below.overlap),_y_next+=3,_x_next+=_curr.x_dim,_x_next-=_next.x_dim,_z_next++):_curr.right.adjacent?(_next=PanelUtils.getPanel(cardList,_curr.right.adjacent),_x_next+=_curr.x_dim,_y_next=0,_z_next-=100):_curr.right.overlap&&(_next=PanelUtils.getPanel(cardList,_curr.right.overlap),_x_next+=3,_x_next+=_curr.x_dim,_x_next-=_next.x_dim,_y_next=0,_z_next-=100),_curr=_next,_count++):PanelUtils.hasNext(_curr)||_count!==_length-1?(_continue=!1,_last.x_coord=-_last.x_dim,_last.y_coord=-_last.y_dim,console.log("Sir, I believe we are experiencing an error.")):(_continue=!1,_last.x_coord=_x_next,_last.y_coord=_y_next,_last.z_coord=_z_next)}}]),angular.module("move").factory("shuffleDeck",["$rootScope","PanelUtils","DeckUtils","setPanelPosition",function($rootScope,PanelUtils,DeckUtils,setPanelPosition){return function(cardList){var _refArray=DeckUtils.getRefArray(cardList);_refArray.sort(function(){return.5-Math.random()});for(var i=0;i<_refArray.length;i++){var _prev=cardList[_refArray[i-1]]||null,_curr=cardList[_refArray[i]],_next=cardList[_refArray[i+1]]||null;

if(_prev){var _1d4=Math.floor(4*Math.random()+1);switch(_1d4){case 1:_prev.above.overLap?PanelUtils.setAdjacentVertical(_prev,_curr):PanelUtils.setAdjacentHorizontal(_prev,_curr);break;case 2:_prev.above.overLap?PanelUtils.setOverlapVertical(_prev,_curr):PanelUtils.setOverlapHorizontal(_prev,_curr);break;case 3:_prev.left.overLap?PanelUtils.setAdjacentHorizontal(_prev,_curr):PanelUtils.setAdjacentVertical(_prev,_curr);break;case 4:_prev.left.overLap?PanelUtils.setOverlapHorizontal(_prev,_curr):PanelUtils.setOverlapVertical(_prev,_curr)}_next||(_curr.below={adjacent:null,overlap:null},_curr.right={adjacent:null,overlap:null})}else _curr.above={adjacent:null,overlap:null},_curr.below={adjacent:null,overlap:null},_curr.left={adjacent:null,overlap:null},_curr.right={adjacent:null,overlap:null}}setPanelPosition(cardList)}}]),angular.module("move").factory("stackOver",["$rootScope","CoreVars","Bakery","PanelUtils","setPanelPosition",function($rootScope,CoreVars,Bakery,PanelUtils,setPanelPosition){return function(cardList,slot,panel){if(!CoreVars.cardMoving){console.log("stackOver"),CoreVars.setCardMoving();var slotStart=PanelUtils.getStackStart(cardList,slot._id),slotEnd=PanelUtils.getStackEnd(cardList,slot._id),slotStartPrev=PanelUtils.getPrev(cardList,slotStart._id).panel,slotEndNext=PanelUtils.getNext(cardList,slotEnd._id).panel,panelStart=PanelUtils.getStackStart(cardList,panel._id),panelEnd=PanelUtils.getStackEnd(cardList,panel._id),panelStartPrev=PanelUtils.getPrev(cardList,panelStart._id).panel,panelEndNext=PanelUtils.getNext(cardList,panelEnd._id).panel,slotOrder=PanelUtils.getPanelOrder(cardList,slot._id),panelOrder=PanelUtils.getPanelOrder(cardList,panel._id),panelStartOrder=PanelUtils.getPanelOrder(cardList,panelStart._id),slotEndOrder=PanelUtils.getPanelOrder(cardList,slotEnd._id);slotOrder>panelOrder?(PanelUtils.setAdjacentVertical(slotEnd,panelStart),PanelUtils.setAdjacentHorizontal(panelEnd,slotEndNext),PanelUtils.setAdjacentHorizontal(panelStartPrev,panelEndNext)):panelOrder>slotOrder&&(PanelUtils.setAdjacentVertical(slotEnd,panelStart),panelStartOrder-slotEndOrder>1&&(PanelUtils.setAdjacentHorizontal(panelEnd,slotEndNext),PanelUtils.setAdjacentHorizontal(panelStartPrev,panelEndNext))),console.log("Panel: "+panelStartPrev._id+" ["+panelStart._id+"-"+panelEnd._id+"] "+panelEndNext._id),console.log("Slot: "+slotStartPrev._id+"["+slotStart._id+"-"+slotEnd._id+"]"+slotEndNext._id),setPanelPosition(cardList),$rootScope.$digest()}}}]),angular.module("move").factory("stackUnder",["$rootScope","CoreVars","Bakery","PanelUtils","setPanelPosition",function($rootScope,CoreVars,Bakery,PanelUtils,setPanelPosition){return function(cardList,slot,panel){if(!CoreVars.cardMoving){console.log("stackUnder"),CoreVars.setCardMoving();var slotOrder=PanelUtils.getPanelOrder(cardList,slot._id),panelOrder=PanelUtils.getPanelOrder(cardList,panel._id),slotStart=PanelUtils.getStackStart(cardList,slot._id),slotEnd=PanelUtils.getStackEnd(cardList,slot._id),slotStartPrev=PanelUtils.getPrev(cardList,slotStart._id).panel,slotEndNext=PanelUtils.getNext(cardList,slotEnd._id).panel,panelStart=PanelUtils.getStackStart(cardList,panel._id),panelEnd=PanelUtils.getStackEnd(cardList,panel._id),panelStartPrev=PanelUtils.getPrev(cardList,panelStart._id).panel,panelEndNext=PanelUtils.getNext(cardList,panelEnd._id).panel;PanelUtils.setOverlapVertical(panelEnd,slotStart),(panelOrder>slotOrder||slotOrder-panelOrder>1)&&(PanelUtils.setAdjacentHorizontal(slotStartPrev,panelStart),PanelUtils.setAdjacentHorizontal(panelStartPrev,panelEndNext)),console.log(panelStartPrev._id+" ["+panelStart._id+"-"+panelEnd._id+"] "+panelEndNext._id+" --> "+slotStartPrev._id+"["+slotStart._id+"-"+slotEnd._id+"]"+slotEndNext._id),setPanelPosition(cardList),$rootScope.$digest()}}}]),angular.module("move").factory("switchHorizontal",["$rootScope","CoreVars","PanelUtils","DeckUtils","setPanelPosition",function($rootScope,CoreVars,PanelUtils,DeckUtils,setPanelPosition){return function(cardList,slot,panel){if(!CoreVars.cardMoving){console.log("switchHorizontal"),CoreVars.setCardMoving();var slotStart=PanelUtils.getRangeStart(cardList,slot._id),slotEnd=PanelUtils.getRangeEnd(cardList,slot._id),slotStartPrev=PanelUtils.getPrev(cardList,slotStart._id).panel,slotEndNext=PanelUtils.getNext(cardList,slotEnd._id).panel,panelStart=PanelUtils.getRangeStart(cardList,panel._id),panelEnd=PanelUtils.getRangeEnd(cardList,panel._id),panelStartPrev=PanelUtils.getPrev(cardList,panelStart._id).panel,panelEndNext=PanelUtils.getNext(cardList,panelEnd._id).panel,slotOrder=PanelUtils.getPanelOrder(cardList,slot._id),panelOrder=PanelUtils.getPanelOrder(cardList,panel._id);slotOrder>panelOrder?(PanelUtils.setAdjacentHorizontal(slotEnd,panelStart),PanelUtils.setAdjacentHorizontal(panelEnd,slotEndNext),PanelUtils.setAdjacentHorizontal(panelStartPrev,panelEndNext)):panelOrder>slotOrder&&(PanelUtils.setAdjacentHorizontal(slotStartPrev,panelStart),PanelUtils.setAdjacentHorizontal(panelEnd,slotStart),PanelUtils.setAdjacentHorizontal(panelStartPrev,panelEndNext)),console.log("Panel: "+panelStartPrev._id+" ["+panelStart._id+"-"+panelEnd._id+"] "+panelEndNext._id),console.log("Slot: "+slotStartPrev._id+"["+slotStart._id+"-"+slotEnd._id+"]"+slotEndNext._id),setPanelPosition(cardList),$rootScope.$digest()}}}]),angular.module("move").factory("switchVertical",["$rootScope","CoreVars","Bakery","PanelUtils","setPanelPosition",function($rootScope,CoreVars,Bakery,PanelUtils,setPanelPosition){return function(cardList,slot,panel){if(!CoreVars.cardMoving){console.log("switchVertical"),CoreVars.setCardMoving();var slotOrder=PanelUtils.getPanelOrder(cardList,slot._id),panelOrder=PanelUtils.getPanelOrder(cardList,panel._id),slotStart=PanelUtils.getStackStart(cardList,slot._id),slotEnd=PanelUtils.getStackEnd(cardList,slot._id),slotStartPrev=PanelUtils.getPrev(cardList,slotStart._id).panel,slotEndNext=PanelUtils.getNext(cardList,slotEnd._id).panel,panelStart=PanelUtils.getStackStart(cardList,panel._id),panelEnd=PanelUtils.getStackEnd(cardList,panel._id),panelStartPrev=PanelUtils.getPrev(cardList,panelStart._id).panel,panelEndNext=PanelUtils.getNext(cardList,panelEnd._id).panel;panelOrder>slotOrder?(console.log("panel moving up"),slotStart.left.adjacent?PanelUtils.setAdjacentHorizontal(slotStartPrev,panelStart):slotStart.above.adjacent?PanelUtils.setAdjacentVertical(slotStartPrev,panelStart):(panelStart.above.adjacent=null,panelStart.left.adjacent=null),panelEnd.right.adjacent?PanelUtils.setAdjacentHorizontal(slotEnd,panelEndNext):panelEnd.below.adjacent?PanelUtils.setAdjacentVertical(slotEnd,panelEndNext):(panelStart.below.adjacent=null,panelStart.right.adjacent=null),PanelUtils.setAdjacentVertical(panelEnd,slotStart)):slotOrder>panelOrder&&(console.log("panel moving down"),panelStart.left.adjacent?PanelUtils.setAdjacentHorizontal(panelStartPrev,slotStart):panelStart.above.adjacent&&PanelUtils.setAdjacentVertical(panelStartPrev,slotStart),slotEnd.right.adjacent?PanelUtils.setAdjacentHorizontal(panelEnd,slotEndNext):slotEnd.below.adjacent&&PanelUtils.setAdjacentVertical(panelEnd,slotEndNext),PanelUtils.setAdjacentVertical(slotEnd,panelStart)),console.log("Panel: "+panelStartPrev._id+" ["+panelStart._id+"-"+panelEnd._id+"] "+panelEndNext._id),console.log("Slot: "+slotStartPrev._id+"["+slotStart._id+"-"+slotEnd._id+"]"+slotEndNext._id),setPanelPosition(cardList),$rootScope.$digest()}}}]),angular.module("move").factory("toggleOverlap",["$rootScope","CoreVars","PanelUtils","setPanelPosition",function($rootScope,CoreVars,PanelUtils,setPanelPosition){return function(cardList,panelId,nearest){if(!CoreVars.cardMoved&&!CoreVars.cardMoving){console.log("toggleOverlap: "+nearest);var _curr=PanelUtils.getPanel(cardList,panelId),_next=(PanelUtils.getPrev(cardList,panelId).panel,PanelUtils.getNext(cardList,panelId).panel),_start=PanelUtils.getStackStart(cardList,panelId),_startPrev=PanelUtils.getPrev(cardList,_start._id).panel;CoreVars.setCardMoving(),!_curr.below.overlap||"above"!==nearest&&"right"!==nearest?_curr.below.adjacent&&!_start.left.overlap&&PanelUtils.setOverlapVertical(_curr,_next):PanelUtils.setAdjacentVertical(_curr,_next),_start.left.overlap?PanelUtils.setAdjacentHorizontal(_startPrev,_start):_start.left.adjacent&&(PanelUtils.hasBelow(_curr)&&"below"!==nearest&&"left"!==nearest||PanelUtils.setOverlapHorizontal(_startPrev,_start)),setPanelPosition(cardList),$rootScope.$digest(),CoreVars.cardMoved=!1}}}]),angular.module("move").factory("unstackCard",["$rootScope","CoreVars","Bakery","PanelUtils","setPanelPosition",function($rootScope,CoreVars,Bakery,PanelUtils,setPanelPosition){return function(cardList,slot,panel){if(!CoreVars.cardMoving){console.log("unstackCard"),CoreVars.setCardMoving();var slotStart=PanelUtils.getStackStart(cardList,slot._id),slotEnd=PanelUtils.getStackEnd(cardList,slot._id),slotStartPrev=PanelUtils.getPrev(cardList,slotStart._id).panel,slotEndNext=PanelUtils.getNext(cardList,slotEnd._id).panel,panelStart=PanelUtils.getStackStart(cardList,panel._id),panelEnd=PanelUtils.getStackEnd(cardList,panel._id),panelStartPrev=PanelUtils.getPrev(cardList,panelStart._id).panel,panelEndNext=PanelUtils.getNext(cardList,panelEnd._id).panel,slotOrder=PanelUtils.getPanelOrder(cardList,slotEnd._id),panelOrder=PanelUtils.getPanelOrder(cardList,panelStart._id);slotOrder>panelOrder?(PanelUtils.setAdjacentHorizontal(panelEnd,slotStart),slotOrder-panelOrder===1&&PanelUtils.setAdjacentHorizontal(panelStartPrev,panelStart),slotOrder-panelOrder>1&&(PanelUtils.setAdjacentHorizontal(panelStartPrev,panelEndNext),PanelUtils.setAdjacentHorizontal(slotStartPrev,panelStart))):panelOrder>slotOrder&&(PanelUtils.setAdjacentHorizontal(panelStartPrev,panelEndNext),PanelUtils.setAdjacentHorizontal(slotEnd,panelStart),PanelUtils.setAdjacentHorizontal(panelEnd,slotEndNext)),console.log("Panel: "+panelStartPrev._id+" ["+panelStart._id+"-"+panelEnd._id+"] "+panelEndNext._id),console.log("Slot: "+slotStartPrev._id+"["+slotStart._id+"-"+slotEnd._id+"]"+slotEndNext._id),setPanelPosition(cardList),$rootScope.$digest()}}}]),angular.module("npcs").controller("NpcsController",["$scope","$stateParams","$location","Authentication","Npcs",function($scope,$stateParams,$location,Authentication,Npcs){$scope.authentication=Authentication,$scope.create=function(){var npc=new Npcs({name:this.name});npc.$save(function(response){$location.path("npcs/"+response._id),$scope.name=""},function(errorResponse){$scope.error=errorResponse.data.message})},$scope.remove=function(npc){if(npc){npc.$remove();for(var i in $scope.npcs)$scope.npcs[i]===npc&&$scope.npcs.splice(i,1)}else $scope.npc.$remove(function(){})},$scope.update=function(){var npc=$scope.npc;npc.$update(function(){},function(errorResponse){$scope.error=errorResponse.data.message})},$scope.find=function(){$scope.npcs=Npcs.query(function(response){console.log(response)})},$scope.findOne=function(){$scope.npc=Npcs.get({npcId:$stateParams.npcId})}}]),angular.module("npcs").factory("Npcs",["$resource",function($resource){return $resource("npcs/:npcId",{npcId:"@_id"},{update:{method:"PUT"}})}]),angular.module("pcs").directive("ability",["$parse","$rootScope","$window","abilityDice",function($parse,$rootScope,$window,abilityDice){return{restrict:"A",link:function(scope,element,attrs){var _ability=$parse(attrs.ability)||null,_pressEvents="touchstart mousedown",initialize=function(){element.attr("draggable","false"),toggleListeners(!0),onHeightChange()},toggleListeners=function(enable){enable&&(scope.$on("$destroy",onDestroy),scope.$watch(attrs.ability,onAbilityChange),scope.$on("screenSize:onHeightChange",onHeightChange),element.on(_pressEvents,onPress))},onDestroy=function(enable){toggleListeners(!1)},getElementFontSize=function(){return parseFloat($window.getComputedStyle(element[0],null).getPropertyValue("font-size"))},convertEm=function(value){return value*getElementFontSize()},onAbilityChange=function(newVal,oldVal){_ability=newVal},getAbility=function(){var offset=element.offset(),caret=_ability.order<4?"top-caret":"bottom-caret",topEdge=_ability.order<4?offset.top+convertEm(3):offset.top-convertEm(9),leftEdge=offset.left-convertEm(.5);return{caret:caret,topEdge:topEdge,leftEdge:leftEdge,ability:_ability}},onHeightChange=function(event,object){_ability.order===abilityDice.chosenAbility.order&&$rootScope.$broadcast("ability:setPosition",getAbility())},onPress=function(){abilityDice.chooseAbility(_ability),$rootScope.$broadcast("ability:onPress",getAbility())};initialize()}}}]),angular.module("pcs").directive("diceBox",["$window",function($window){return{restrict:"A",templateUrl:"../modules/pcs/views/dice-box.html",link:function(scope,element,attrs){var initialize=function(){element.attr("draggable","false"),toggleListeners(!0)},toggleListeners=function(enable){enable&&(scope.$on("$destroy",onDestroy),scope.$on("ability:onPress",setPosition),scope.$on("ability:setPosition",setPosition))},onDestroy=function(enable){toggleListeners(!1)},setPosition=function(event,object){var _caret=object.caret,_topEdge=object.topEdge,_leftEdge=object.leftEdge;element.removeClass("top-caret"),element.removeClass("bottom-caret"),element.addClass(_caret),element.css({top:_topEdge+"px",left:_leftEdge+"px"})};initialize()}}}]),angular.module("pcs").directive("modalDeck",["$window",function($window){return{restrict:"A",templateUrl:"../modules/pcs/views/modal-deck.html",link:function(scope,element,attrs){}}}]),angular.module("pcs").factory("PcsAugments",["PanelUtils",function(PanelUtils){var service={};return service.factorAugmentLimit=function(pcResource){pcResource.augmentLimit=Math.round((pcResource.level||0)/4),service.validateAugments(pcResource)},service.validateAugments=function(pcResource){for(var ia=0;ia<pcResource.augmentLimit;ia++)service.augmentAtLevel(pcResource,4*ia+2)||service.addAugment(pcResource,4*ia+2);for(var ic=0;ic<pcResource.cardList.length;ic++)pcResource.cardList[ic].level>pcResource.level&&console.log("TODO: remove card")},service.augmentAtLevel=function(pcResource,level){for(var augmentAtLevel=!1,ib=0;ib<pcResource.cardList.length;ib++)"Augment"===pcResource.cardList[ib].panelType&&pcResource.cardList[ib].level===level&&(augmentAtLevel=!0);return augmentAtLevel},service.addAugment=function(pcResource,level){var _lastPanel=PanelUtils.getLast(pcResource.cardList).panel,_newAugment={_id:"augment"+level+"Id",panelType:"Augment",x_coord:_lastPanel.x_coord+15,y_coord:0,x_dim:15,y_dim:21,locked:!0,level:level,augmentData:{_name:"Level "+level+" Augment"},above:{adjacent:null,overlap:null},below:{adjacent:null,overlap:null},left:{adjacent:_lastPanel._id,overlap:null},right:{adjacent:null,overlap:null}};_lastPanel.right.adjacent=_newAugment._id,pcResource.cardList.push(_newAugment),pcResource.$update()},service}]),angular.module("pcs").factory("PcsBread",["Bakery","CoreVars","PanelUtils","DeckUtils","pcsDefaults",function(Bakery,CoreVars,PanelUtils,DeckUtils,pcsDefaults){var service={};return service.browse=function(){Bakery.resource={},Bakery.resource.cardList=[],Bakery.Pcs.query(function(response){response.unshift({_id:"playerOptionsId",panelType:"playerOptions",x_dim:18,y_dim:21}),Bakery.resource.cardList=response,DeckUtils.setCardList(Bakery.resource.cardList)})},service.read=function(pc){Bakery.resource=Bakery.Pcs.get({pcId:pc._id})},service.edit=function(pc){pc.$update(function(response){console.log(response)},function(errorResponse){this.error=errorResponse.data.message})},service.add=function(){var pc=new Bakery.Pcs(pcsDefaults);pc.$save(function(response){for(var i=0;i<response.cardList.length;i++){var current=response.cardList[i],previous=CoreVars.nullPanel;i>0&&(previous=response.cardList[i-1]),previous.right.adjacent=current._id,current.left.adjacent=previous._id}pc.$update(function(response){Bakery.resource=response})})},service["delete"]=function(resource,pc){pc.x_coord,pc.y_coord;pc.$remove(function(response){resource&&PanelUtils.removePanel(resource.cardList,pc)}).then(function(response){resource&&DeckUtils.setDeckSize(resource)}).then(function(response){resource&&DeckUtils.collapseDeck(resource.cardList,pc)})},service}]),angular.module("pcs").factory("pcsDefaults",[function(){var defaultStats={abilities:[{name:"Strength",order:0,dice:{name:"d__",image:"modules/core/img/d___.png",sides:"0",order:0}},{name:"Physique",order:1,dice:{name:"d__",image:"modules/core/img/d___.png",sides:"0",order:0}},{name:"Flexibility",order:2,dice:{name:"d__",image:"modules/core/img/d___.png",sides:"0",order:0}},{name:"Dexterity",order:3,dice:{name:"d__",image:"modules/core/img/d___.png",sides:"0",order:0}},{name:"Acuity",order:4,dice:{name:"d__",image:"modules/core/img/d___.png",sides:"0",order:0}},{name:"Intelligence",order:5,dice:{name:"d__",image:"modules/core/img/d___.png",sides:"0",order:0}},{name:"Wisdom",order:6,dice:{name:"d__",image:"modules/core/img/d___.png",sides:"0",order:0}},{name:"Charisma",order:7,dice:{name:"d__",image:"modules/core/img/d___.png",sides:"0",order:0}}],dicepool:[{name:"d__",image:"modules/core/img/d___.png",sides:"0",order:0},{name:"d4",image:"modules/core/img/d_04.png",sides:"4",order:1},{name:"d6",image:"modules/core/img/d_06.png",sides:"6",order:2},{name:"d6",image:"modules/core/img/d_06.png",sides:"6",order:3},{name:"d8",image:"modules/core/img/d_08.png",sides:"8",order:4},{name:"d8",image:"modules/core/img/d_08.png",sides:"8",order:5},{name:"d10",image:"modules/core/img/d_10.png",sides:"10",order:6},{name:"d10",image:"modules/core/img/d_10.png",sides:"10",order:7},{name:"d12",image:"modules/core/img/d_12.png",sides:"12",order:8}],cardList:[{panelType:"pc1",x_coord:0,y_coord:0},{panelType:"pc2",x_coord:15,y_coord:0},{panelType:"pc3",x_coord:30,y_coord:0}]};return defaultStats}]),angular.module("pcs").factory("PcsFeats",["PanelUtils",function(PanelUtils){var service={};return service.factorFeatLimit=function(pcResource){pcResource.featLimit=Math.ceil(pcResource.level/4)||0,pcResource.featDeck=pcResource.level,service.validateFeats(pcResource)},service.validateFeats=function(pcResource){for(var ia=0;ia<pcResource.featDeck;ia++)service.featAtLevel(pcResource,ia+1)||service.addFeat(pcResource,ia+1);for(var ic=0;ic<pcResource.cardList.length;ic++)pcResource.cardList[ic].level>pcResource.level&&console.log("TODO: remove card")},service.featAtLevel=function(pcResource,level){for(var featAtLevel=!1,ib=0;ib<pcResource.cardList.length;ib++)"Feat"===pcResource.cardList[ib].panelType&&pcResource.cardList[ib].level===level&&(featAtLevel=!0);return featAtLevel},service.addFeat=function(pcResource,level){var _lastPanel=PanelUtils.getLast(pcResource.cardList).panel,_newFeat={_id:"feat"+level+"Id",panelType:"Feat",x_coord:_lastPanel.x_coord+15,y_coord:0,x_dim:15,y_dim:21,locked:!0,level:level,featData:{name:"Level "+level+" Feat"},above:{adjacent:null,overlap:null},below:{adjacent:null,overlap:null},left:{adjacent:_lastPanel._id,overlap:null},right:{adjacent:null,overlap:null}};_lastPanel.right.adjacent=_newFeat._id,pcResource.cardList.push(_newFeat),pcResource.$update()},service}]),angular.module("pcs").factory("PcsItems",["Bakery",function(Bakery){var service={};return service}]),angular.module("pcs").factory("PcsTraits",["PanelUtils",function(PanelUtils){var service={};return service.factorTraitLimit=function(pcResource){pcResource.traitLimit=Math.floor((pcResource.level||0)/4+1),service.validateTraits(pcResource)},service.validateTraits=function(pcResource){for(var ia=0;ia<pcResource.traitLimit;ia++)service.traitAtLevel(pcResource,4*ia)||service.addTrait(pcResource,4*ia);for(var ic=0;ic<pcResource.cardList.length;ic++)pcResource.cardList[ic].level>pcResource.level&&console.log("TODO: remove card")},service.traitAtLevel=function(pcResource,level){for(var traitAtLevel=!1,ib=0;ib<pcResource.cardList.length;ib++)"Trait"===pcResource.cardList[ib].panelType&&pcResource.cardList[ib].level===level&&(traitAtLevel=!0);return traitAtLevel},service.addTrait=function(pcResource,level){var _lastPanel=PanelUtils.getLast(pcResource.cardList).panel,_newTrait={_id:"trait"+level+"Id",panelType:"Trait",x_coord:_lastPanel.x_coord+15,y_coord:0,x_dim:15,y_dim:21,locked:!0,level:level,traitData:{name:"Level "+level+" Trait"},above:{adjacent:null,overlap:null},below:{adjacent:null,overlap:null},left:{adjacent:_lastPanel._id,overlap:null},right:{adjacent:null,overlap:null}};_lastPanel.right.adjacent=_newTrait._id,pcResource.cardList.push(_newTrait),pcResource.$update()},service}]),angular.module("decks").factory("Pcs",["$resource",function($resource){return $resource("pcs/:pcId",{pcId:"@_id"},{update:{method:"PUT"}})}]),angular.module("player").factory("abilityDice",["$rootScope","CoreVars","Bakery",function($rootScope,CoreVars,Bakery){var service={};service.chosenAbility={};var chosenDie={},previousDie={};return service.chooseAbility=function(ability){console.log(ability),CoreVars.modalShown=!0,CoreVars.diceBoxShown=!0,service.chosenAbility=ability},service.chooseDie=function(resource,order){CoreVars.modalShown=!1,CoreVars.diceBoxShown=!1,chosenDie=resource.dicepool[order],previousDie=service.chosenAbility.dice,resource.dicepool[order]=resource.dicepool[0],previousDie.order>0&&(resource.dicepool[previousDie.order]=previousDie),resource.abilities[service.chosenAbility.order].dice=chosenDie},service}]),angular.module("player").factory("factorDefenses",[function(){var service={};return service.factorBlock=function(resource){var dice_a=resource.abilities[0].dice,dice_b=resource.abilities[1].dice;Number(dice_a.sides)>Number(dice_b.sides)?resource.block="2"+dice_a.name:resource.block="2"+dice_b.name},service.factorDodge=function(resource){var dice_a=resource.abilities[2].dice,dice_b=resource.abilities[3].dice;Number(dice_a.sides)>Number(dice_b.sides)?resource.dodge="2"+dice_a.name:resource.dodge="2"+dice_b.name},service.factorAlertness=function(resource){var dice_a=resource.abilities[4].dice,dice_b=resource.abilities[5].dice;Number(dice_a.sides)>Number(dice_b.sides)?resource.alertness="2"+dice_a.name:resource.alertness="2"+dice_b.name},service.factorTenacity=function(resource){var dice_a=resource.abilities[6].dice,dice_b=resource.abilities[7].dice;Number(dice_a.sides)>Number(dice_b.sides)?resource.tenacity="2"+dice_a.name:resource.tenacity="2"+dice_b.name},service}]),angular.module("player").factory("factorStats",["CoreVars",function(CoreVars){var service={};return service.factorExperience=function(resource){for(var mLevel=0,mExperience=Number(resource.experience),increment=8;mExperience>=increment;increment++)mLevel++,mExperience-=increment;resource.level=mLevel},service.factorHealth=function(resource){resource.healthLimit=Math.round((Number(resource.abilities[0].dice.sides)+Number(resource.abilities[1].dice.sides))*((resource.level||0)/16+1)),resource.healthCurrent=Number(resource.healthLimit-resource.injury)},service.factorStamina=function(resource){resource.staminaLimit=Math.round((Number(resource.abilities[0].dice.sides)+Number(resource.abilities[1].dice.sides))*((resource.level||0)/16+1)),resource.staminaCurrent=Number(resource.healthLimit-resource.injury)},service.factorCarryingCapacity=function(resource){resource.carryCurrent=0,resource.carryLimit=Number(resource.abilities[0].dice.sides)+Number(resource.abilities[1].dice.sides)},service}]),angular.module("player").factory("PlayerHub",["$rootScope","CoreVars","Bakery","factorDefenses","factorStats","PcsTraits","PcsFeats","PcsAugments","abilityDice",function($rootScope,CoreVars,Bakery,factorDefenses,factorStats,PcsTraits,PcsFeats,PcsAugments,abilityDice){var service={};return service.chooseDie=function(order){switch(abilityDice.chooseDie(Bakery.resource,order),abilityDice.chosenAbility.order){case 0:case 1:factorDefenses.factorBlock(Bakery.resource),factorStats.factorHealth(Bakery.resource),factorStats.factorStamina(Bakery.resource),factorStats.factorCarryingCapacity(Bakery.resource);break;case 2:case 3:factorDefenses.factorDodge(Bakery.resource);break;case 4:case 5:factorDefenses.factorAlertness(Bakery.resource);break;case 6:case 7:factorDefenses.factorTenacity(Bakery.resource)}},service.watchEXP=function(newValue,oldValue){"pc"===Bakery.resource.deckType&&newValue!==oldValue&&(CoreVars.EXP=parseInt(newValue),Bakery.resource.experience=parseInt(newValue))},service.watchExperience=function(newValue,oldValue){"pc"===Bakery.resource.deckType&&newValue!==oldValue&&(factorStats.factorExperience(Bakery.resource),newValue!==CoreVars.EXP&&(CoreVars.EXP=newValue))},service.watchLevel=function(newValue,oldValue){"pc"===Bakery.resource.deckType&&(factorStats.factorHealth(Bakery.resource),factorStats.factorStamina(Bakery.resource),PcsTraits.factorTraitLimit(Bakery.resource),PcsFeats.factorFeatLimit(Bakery.resource),PcsAugments.factorAugmentLimit(Bakery.resource))},service}]),angular.module("users").config(["$httpProvider",function($httpProvider){$httpProvider.interceptors.push(["$q","$location","Authentication",function($q,$location,Authentication){return{responseError:function(rejection){switch(rejection.status){case 401:Authentication.user=null,$location.path("signin");break;case 403:}return $q.reject(rejection)}}}])}]),angular.module("users").config(["$stateProvider",function($stateProvider){$stateProvider.state("profile",{url:"/settings/profile",templateUrl:"modules/users/views/settings/edit-profile.client.view.html"}).state("password",{url:"/settings/password",templateUrl:"modules/users/views/settings/change-password.client.view.html"}).state("accounts",{url:"/settings/accounts",templateUrl:"modules/users/views/settings/social-accounts.client.view.html"}).state("signup",{url:"/signup",templateUrl:"modules/users/views/authentication/signup.client.view.html"}).state("signin",{url:"/signin",templateUrl:"modules/users/views/authentication/signin.client.view.html"}).state("forgot",{url:"/password/forgot",templateUrl:"modules/users/views/password/forgot-password.client.view.html"}).state("reset-invlaid",{url:"/password/reset/invalid",templateUrl:"modules/users/views/password/reset-password-invalid.client.view.html"}).state("reset-success",{url:"/password/reset/success",templateUrl:"modules/users/views/password/reset-password-success.client.view.html"}).state("reset",{url:"/password/reset/:token",templateUrl:"modules/users/views/password/reset-password.client.view.html"})}]),angular.module("users").controller("AuthenticationController",["$scope","$http","$location","Authentication",function($scope,$http,$location,Authentication){$scope.authentication=Authentication,$scope.authentication.user&&$location.path("/"),$scope.signup=function(){$http.post("/auth/signup",$scope.credentials).success(function(response){$scope.authentication.user=response,$location.path("/")}).error(function(response){$scope.error=response.message})},$scope.signin=function(){$http.post("/auth/signin",$scope.credentials).success(function(response){$scope.authentication.user=response,$location.path("/")}).error(function(response){$scope.error=response.message})}}]),angular.module("users").controller("PasswordController",["$scope","$stateParams","$http","$location","Authentication",function($scope,$stateParams,$http,$location,Authentication){$scope.authentication=Authentication,$scope.authentication.user&&$location.path("/"),$scope.askForPasswordReset=function(){$scope.success=$scope.error=null,$http.post("/auth/forgot",$scope.credentials).success(function(response){$scope.credentials=null,$scope.success=response.message}).error(function(response){$scope.credentials=null,$scope.error=response.message})},$scope.resetUserPassword=function(){$scope.success=$scope.error=null,$http.post("/auth/reset/"+$stateParams.token,$scope.passwordDetails).success(function(response){$scope.passwordDetails=null,Authentication.user=response,$location.path("/password/reset/success")}).error(function(response){$scope.error=response.message})}}]),angular.module("users").controller("SettingsController",["$scope","$http","$location","Users","Authentication",function($scope,$http,$location,Users,Authentication){$scope.user=Authentication.user,$scope.user||$location.path("/"),$scope.hasConnectedAdditionalSocialAccounts=function(provider){for(var i in $scope.user.additionalProvidersData)return!0;return!1},$scope.isConnectedSocialAccount=function(provider){return $scope.user.provider===provider||$scope.user.additionalProvidersData&&$scope.user.additionalProvidersData[provider]},$scope.removeUserSocialAccount=function(provider){$scope.success=$scope.error=null,$http["delete"]("/users/accounts",{params:{provider:provider}}).success(function(response){$scope.success=!0,$scope.user=Authentication.user=response}).error(function(response){$scope.error=response.message})},$scope.updateUserProfile=function(isValid){if(isValid){$scope.success=$scope.error=null;var user=new Users($scope.user);user.$update(function(response){$scope.success=!0,Authentication.user=response},function(response){$scope.error=response.data.message})}else $scope.submitted=!0},$scope.changeUserPassword=function(){$scope.success=$scope.error=null,$http.post("/users/password",$scope.passwordDetails).success(function(response){$scope.success=!0,$scope.passwordDetails=null}).error(function(response){$scope.error=response.message})}}]),angular.module("users").factory("Authentication",[function(){var _this=this;return _this._data={user:window.user},_this._data}]),angular.module("users").factory("Users",["$resource",function($resource){return $resource("users",{},{update:{method:"PUT"}})}]);